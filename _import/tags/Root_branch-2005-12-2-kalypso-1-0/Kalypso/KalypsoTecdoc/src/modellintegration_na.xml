<?xml version="1.0" encoding="UTF-8"?>
<section id="modell-we" vendor="sachsen">
	<title>Modellintegration Kalypso-NA (Weiße Elster)</title>
	
	<para>Das Niederschlag-Abfluss-Modell-Plugin integriert den Rechenkern Kalypso-NA
		in die Benutzeroberfläche Kalypso-Enterprise zum Zweck der Abflussvorhersage,
		Nachrechnung historischer Ereignisse und zur Simulation von
		Modellvarianten.</para>
	
	<section>
		<title>Modellintegration Client</title>
		
		<section>
			<title>Modellprojekt Weiße Elster:</title>
			
			<para>Beschreibung der Dateien und Verzeichnisse (im folgenden bezeichnet
				ein führendes "/" in Pfadangaben das Projektverzeichnis.).</para>
			
			<formalpara>
				<title><filename>/modell.gml:</filename></title>
				
				<para>Modelldatensatz bestehend aus den Modellelementen: Teilgebiete,
					Gewässerstränge und Gewässerknoten. Die entsprechenden
					Modellparameter sind den Elementen zugeordnet, u.a. auch Geometrien
					für die grafische Visualisierung und Verknüpfungen auf Zeitreihen.
					Diese Datei beinhaltet die initialen Modelldaten, die für die
					Erzeugung eines Rechenfalles oder für eine Vorhersagerechnung
					übernommen werden. Die einzelnen Modellparameter sind im
					zugehörigen GML-Schema /.model/schema/namodell.xsd
					dokumentiert. <emphasis role="bold">Ansichten:</emphasis>
					
					<glosslist>
						<glossentry>
							<glossterm><filename>/Modell_Karten/Karte.gmt</filename>
							</glossterm>
							<glossdef>
								<para>Kartenansicht des Gesamtmodells</para>
							</glossdef>
						</glossentry>
						<glossentry>
							<glossterm><filename>/Modell_Tabellen/Tabelle_Knoten.gtt</filename>
							</glossterm>
							<glossdef>
								<para>Tabellenansicht der Modellknoten</para>
							</glossdef>
						</glossentry>
						<glossentry>
							<glossterm><filename>Modell_Tabellen/Tabelle_KMGewaesser.gtt</filename>
							</glossterm>
							<glossdef>
								<para>Tabellenansicht der Gewässerstränge</para>
							</glossdef>
						</glossentry>
						<glossentry>
							<glossterm><filename>/Modell_Tabellen/Tabelle_Teilgebiete.gtt</filename>
							</glossterm>
							<glossdef>
								<para>Tabellenansicht der Teilgebiete</para>
							</glossdef>
						</glossentry>
					</glosslist> </para> </formalpara>
			
			<formalpara>
				<title><filename>/ombometer.gml</filename></title>
				
				<para> <emphasis role="bold">Inhalt:</emphasis> Datenmodell der
					Niederschlagsmessungen: Standpunkte der Ombrometer und deren
					Verknüpfungen mit dem Zeitreihenrepository. <emphasis
						role="bold">Ansichten:</emphasis>
					
					<glosslist>
						<glossentry>
							<glossterm><filename>/Modell_Karten/Ombrometer.gmt</filename>
							</glossterm>
							<glossdef>
								<para>Kartenansicht des Gesamtmodells</para>
							</glossdef>
						</glossentry>
					</glosslist> <emphasis role="bold"> Verzeichnisse</emphasis>
					
					<glosslist>
						<glossentry> <glossterm><filename>/.model/...</filename>
							</glossterm>
							<glossdef><para> Konfigurationen der Modells und der
								Rechenvarianten</para>
							</glossdef>
						</glossentry>
						<glossentry>
							<glossterm><filename>/.prognose/...</filename>
							</glossterm>
							<glossdef><para>Verzeichnis für die
								Vorhersagerechnungen</para></glossdef>
						</glossentry>
						<glossentry> <glossterm><filename>/.styles/...</filename>
							</glossterm>
							<glossdef><para>Visualisierungsvorschriften für
								Kartenansichten</para></glossdef>
						</glossentry>
						<glossentry>
							<glossterm><filename>/.templates/...</filename>
							</glossterm>
							<glossdef><para>Vorlagen zur Generierung von
								Rechenvarianten</para></glossdef>
						</glossentry>
						<glossentry>
							<glossterm><filename>/Rechenvarianten/...</filename>
							</glossterm>
							<glossdef><para>Verzeichnis für die Berechnungen im
								Expertenmodus</para></glossdef>
						</glossentry>
					</glosslist> </para> </formalpara>
			
			<section>
				<title>Konfiguration der Rechenvariante</title>
				
				<formalpara>
					<title><filename>/.model/calcCaseConfig.xml</filename>
					</title>
					
					<para>Inhalt: Konfiguration der Transformationen zur Erstellung
						einer Rechenvariante. <emphasis role="bold">
						Erstellungstransformationen:</emphasis>
						
						<orderedlist>
							<listitem>
								<para>Kopieren des initialen Modelldatensatzes
									<filename>/modell.gml nach
									Rechenvariante/calcCase.gml</filename>
									.</para>
							</listitem>
							<listitem>
								<para>Kopieren von Steuerdateien und Ansichtsdateien
									aus dem Vorlagenverzeichnis
									<filename>/.templates/calcCase/</filename>
									zur Rechenvariante.</para>
							</listitem>
							<listitem>
								<para>Anlegen des Verzeichnis
									<filename>Ergebnisse/</filename> Hier werden
									die Ergebnisse der Simulationsrechnung
									gespeichert.</para>
							</listitem>
							<listitem>
								<para>Kopieren von Vorlagendateien aus dem Ordner
									<filename>./templates/calcCase</filename> in
									das Rechenverzeichnis.</para>
							</listitem>
							<listitem>
								<para>Kopieren der Konfiguration zur Optimierung
									<filename>./templates/calcCase/sce.xml</filename>
									in das Rechenverzeichnis.</para>
							</listitem>
						</orderedlist> <emphasis role="bold">
						Updatetransformationen:</emphasis>
						
						<orderedlist>
							<listitem>
								<para>Zeitreihen der gemessenen Niederschläge zur
									Kontrolle der Eingangsdaten -&gt;
									<filename>Verzeichnis Ombrometer/</filename>
									</para>
							</listitem>
							<listitem>
								<para>Zeitreihen der Pegelmessungen zum visuellen
									Vergleich und zur Parameteroptimierung -&gt;
									V<filename>erzeichnis Pegel/</filename>
									</para>
							</listitem>
							<listitem>
								<para>Zeitreihen der Zuflussganglinien -&gt;
									<filename>Verzeichnis Zufluss/</filename>
									</para>
							</listitem>
							<listitem>
								<para>Zeitreihen der Gebietsniederschläge -&gt;
									<filename>Verzeichnis
									Niederschlag/</filename> </para>
							</listitem>
						</orderedlist> </para> </formalpara>
				
				<formalpara>
					<title><filename>/.model/modelspec.xml</filename>
					</title>
					
					<para>Inhalt: Konfiguration der Dateien und Verzeichnisse, die bei
						einer Berechnung im Expertenmodus zum Rechendienst übertragen
						werden.
						
						<figure>
							<title>Darstellung</title>
							
							<mediaobject>
								<imageobject>
									<imagedata
										fileref="img/kap9/Konfiguration_Rechenvariante.png"/>
								</imageobject>
							</mediaobject>
						</figure> </para> </formalpara>
				
				<formalpara>
					<title><filename>/.model/modelspec[1-17].xml</filename>
					</title>
					
					<para>Für die Berechnung im Vorhersageemodus existiert für jeden
						Vorhersagepegel [1-17] eine Konfiguration der Dateien und
						Verzeichnisse, die zum Rechendienst übertragen werden.Diese
						unterscheiden sich vom Expertenmodus durch unterschiedliche
						Steuerdateien (ID=Control).</para> </formalpara>
				
				<formalpara>
					<title><filename>/.model/calcWizard.xml</filename>
					</title>
					
					<para>Inhalt: Konfiguration der einzelnen Wizardseiten für die
						Benutzerführung des Vorhersagemodus.</para> </formalpara>
			</section>
			
			<section>
				<title>Aufbau Rechenvariante</title>
				
				<formalpara>
					<title>Zur Rechenvariante gehören folgende Daten- und
						Vorlagendateien:</title>
					
					<para>Vorlagendateien zu den Modelldaten
						<filename>(calcCase.gml)</filename>:
						
						<glosslist>
							<glossentry>
								<glossterm><filename>expertKarte.gmt:</filename>
								</glossterm>
								<glossdef>
									<para>Karteneditor</para>
								</glossdef>
							</glossentry>
							<glossentry>
								<glossterm><filename>expertTabelleKnoten.gtt:</filename>
								</glossterm>
								<glossdef>
									<para>Tabelleneditor Knoten</para>
								</glossdef>
							</glossentry>
							<glossentry>
								<glossterm><filename>expertTabelleGewaesser.gtt:</filename>
								</glossterm>
								<glossdef>
									<para>Tabelleneditor Gewässerstränge</para>
								</glossdef>
							</glossentry>
							<glossentry>
								<glossterm><filename>expertTabelleTeilgebiete.gtt:</filename>
								</glossterm>
								<glossdef>
									<para>Tabelleneditor Teilgebiete</para>
								</glossdef>
							</glossentry>
						</glosslist> </para> </formalpara>
				
				<formalpara>
					<title>Vorlagendateien zum Steuerungsdatensatz
						<filename>(expertControl.gml)</filename></title>
					
					<para>
						
						<glosslist>
							<glossentry> <glossterm><filename>ExpertControl.gft:
								</filename></glossterm>
								<glossdef><para>Editor der Steuerparameter
									(Korrekturwerte NA-Modell)</para>
								</glossdef>
							</glossentry>
						</glosslist> </para> </formalpara>
				
				<formalpara>
					<title>Weitere Dateien:</title>
					<para>
						<glosslist>
							<glossentry>
								<glossterm><filename>.calculation</filename>
								</glossterm>
								<glossdef>
									<para>Berechnungszeitraum und Metadaten der
										Variantenerstellung.</para>
								</glossdef>
							</glossentry>
							<glossentry> <glossterm><filename>.sce.xml</filename>
								</glossterm>
								<glossdef>
									<para>Steuerdatei zur Parameteroptimierung.
										(wird vom Benutzer nicht verändert)</para>
								</glossdef>
							</glossentry>
						</glosslist> </para> </formalpara>
				
				<formalpara>
					<title>Steuerdateien Vorhersagemodus:</title>
					
					<para>Je Vorhersagepegel (1-17) existiert eine Steuerungsdatei
						(.nacontrol_[1-17].gml), welche vom Vorhersage-Wizard
						verwendet wird.</para> </formalpara>
			</section>
		</section>
		
		<section>
			<title>Modellintegration Server</title>
			
			<para>Die Programmierung zur Modellintegration findet sich im
				Quellcodeprojekt KalypsoNA. Dort befindet sich ebenfalls der Rechenkern
				(fortran-win32-exe) des NA-Modells "Kalypso.exe". Er wird zur
				Berechnung ins Arbeitsverzeichnis kopiert.</para>
			
			<para>Die Programmierung beinhaltet:
				
				<itemizedlist>
					<listitem>
						<para>Konvertierung der Modelldaten in die nativen Formate des
							Rechenkerns</para>
					</listitem>
					<listitem>
						<para>Anstoßen des Rechenkerns</para>
					</listitem>
					<listitem>
						<para>Kontrolle des Simulationsablauf</para>
					</listitem>
					<listitem>
						<para>Konvertierung der nativen Simulations-Ergebnisdaten in
							das Kalypso-Zeitreihenformat</para>
					</listitem>
				</itemizedlist> </para>
			
			<para>Die Integration zur Optimierung ist im Quellcodeprojekt
				KalypsoOptimizePlugin enthalten und wird von KalypsoNA benutzt. Dort
				befindet sich die Implementierung des Optimierungsalgorithmus als
				fortran-win32-exe "sce.exe_". Zur Durchführung der Optimierung wird sie
				ebenfalls ins Arbeitsverzeichnis kopiert.</para>
			
			<section>
				<title>Ablaufschema bei Modellrechnung ohne
					Parameter-Optimierung</title>
				
				<para>Zunächst werden die Daten (nach modelspec.xml) zum Rechendienst
					übertragen. Dort werden folgende Schritte durchgeführt:</para>
				
				<orderedlist>
					<listitem>
						<para>Der Berechnungszeitraum wird aus der Datei
							<filename>.calculation</filename> übernommen.</para>
					</listitem>
					
					<listitem>
						<para>Die Modelldaten werden aus der Datei
							<filename>calCase.gml</filename> eingeladen.</para>
					</listitem>
					
					<listitem>
						<para>Auf die Modelldaten werden die Korrekturwerte aus den
							Steuerdateien angewendet. Es unterscheidet sich der
							Expertenmodus vom Vorhersagemodus wie folgt:</para>
						
						<itemizedlist>
							<listitem>
								<para>Im Expertenmodus werden die Korrekturen auf das
									gesamte Modellgebiet angewendet.</para>
							</listitem>
							<listitem>
								<para>Für den Vorhersagemodus ist in den einzelnen
									Steuerdateien jeweils eingestellt, welche
									Elemente (Teilgebiete und Gewässerabschnitte)
									den zu berechneten Vorhersagepegel speisen. Es
									sind genau diejenigen Elemente eingestellt, die
									zwischen aktuellem Vorhersagepegel und den
									Vorhersagepegeln im Oberwasser liegen. Im
									Vorhersagemodus werden die Korrekturen nur auf das
									so definierte Teilmodell angewendet.</para>
							</listitem>
						</itemizedlist>
					</listitem>
					
					<listitem>
						<para>Die Berechnung wird durchgeführt</para>
					</listitem>
					
					<listitem>
						<para>Resultate und native Dateien des Rechenkerns werden zum
							Client übertragen.</para>
					</listitem>
				</orderedlist>
			</section>
			
			<section>
				<title>Ablaufschema bei Modellrechnung mit
					Parameter-Optimierung</title>
				
				<para>Im Vorhersagemodus hat der Anwender die Möglichkeit im
					Worhersage-Wizard für einen Berechnung eine Parameter-Optimierung
					zu benutzen. Der Rechendienst erkennt dies durch einen Eintrag in den
					Steuerdateien .control_*.gml.</para>
				
				<para>Ist die Optimierung gewünscht, werden im Unterschied zur
					Modellrechnung ohne Parameter-Optimierung keine
					Korrekturparameter auf die Modelldaten angewendet, sondern im
					Gegenteil optimierte Korrekturparameter durch den
					Shuffeld-Complex-Evolution-Algorithmus (SCE) ermittelt.</para>
				
				<para>Die Parameter zur Optimierung werden bezogen aus:
					
					<orderedlist>
						<listitem>
							<para>der Datei <filename>.sce.xml</filename> :
								Parametergrenzen, Konfiguration der
								Bewertungsfunktionen und Steuerparameter zum
								Iterationsverhalten (Anzahl der Komplexe,
								Abbruchkriterien usw.)</para>
						</listitem>
						
						<listitem>
							<para>der Steuerdatei
								<filename>.nacontrol*.gml</filename> . Referenz auf
								Pegelganglinie (als Zielwert) und Referenz auf
								Berechnungsganglinie (als
								Optimierungswert).</para>
						</listitem>
					</orderedlist> </para>
				
				<para>Nach erfolgter Optimierung der Korrekturwerte wird das optimierte
					Simulationsergebnis sowie die Steuerdatei mit den ermittelten
					Korrekturwerten zum Client übertragen.</para>
				
				<para>Die Optimierung ist nur im Vorhersagemodus möglich.</para>
			</section>
		</section>
	</section>
</section>
