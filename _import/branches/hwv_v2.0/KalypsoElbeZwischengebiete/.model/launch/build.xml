<project default="fake">

	<!-- Zeitschritt der Berechnung: 3h-->
	<property name="interval.field" value="HOUR_OF_DAY"/>
	<property name="interval.amount" value="3"/>
	
    <!-- define the requests -->
    <property name="requestQ"
		value="&lt;request xmlns=&quot;request.zml.kalypso.org&quot;&gt;&lt;axes&gt;date,Q&lt;/axes&gt;&lt;statusAxes&gt;Q&lt;/statusAxes&gt;&lt;/request&gt;" />
	
	<!-- Vordefinierte Filter -->
    <!-- Q: interpolation-filter -->
    <property name="filterQ"
		value="${requestQ}&lt;filter&gt;&lt;interpolationFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; defaultStatus=&quot;2&quot; defaultValue=&quot;0.0&quot; forceFill=&quot;true&quot; xmlns=&quot;filters.zml.kalypso.org&quot; fillLastWithValid=&quot;true&quot; /&gt;&lt;/filter&gt;" />
    <property name="filterQDefault0"
		value="${requestQ}&lt;filter&gt;&lt;interpolationFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; defaultStatus=&quot;0&quot; defaultValue=&quot;0.0&quot; forceFill=&quot;true&quot; xmlns=&quot;filters.zml.kalypso.org&quot; fillLastWithValid=&quot;true&quot; /&gt;&lt;/filter&gt;" />
	
	<!-- Filter für GmlWeightTask: wird auf jede Quelle angewendet. Wird eigentlich nur benötigt, um das Ergebnis auf den Vorhersagezeitraum auszuweiten (und fortzusetzen). -->
    <property name="filterWeight"
		value="&lt;filter&gt;&lt;interpolationFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; defaultStatus=&quot;0&quot; defaultValue=&quot;0.0&quot; forceFill=&quot;true&quot; xmlns=&quot;filters.zml.kalypso.org&quot; fillLastWithValid=&quot;true&quot; /&gt;&lt;/filter&gt;" />

    <property name="filterAblageQ"
              value="&lt;filter&gt;&lt;interpolationFilter amount=&quot;15&quot; calendarField=&quot;MINUTE&quot; defaultStatus=&quot;4&quot; defaultValue=&quot;0.0&quot; forceFill=&quot;true&quot; xmlns=&quot;filters.zml.kalypso.org&quot;/&gt;&lt;/filter&gt;" />
	
	<!-- - - - - - - - - - - - - - - - - - 
          target: fake                      nur damit das Projekt nicht schreit
         - - - - - - - - - - - - - - - - - -->
	<target name="fake"/>
 	<!-- 
		 ================================= 
          target: create			Rechenvariante erzeugen
         ================================= 
    -->
 	<target name="create" description="Erzeugt eine Rechenvariante">
  		<echo message="Rechenvariante anlegen: ${calc.dir}"/>

		<copy file="${project.dir}/modell.gml" tofile="${calc.dir}/calcCase.gml"/>
		<copy file="${project.dir}/.templates/.calculation.template" tofile="${calc.dir}/.calculation"/>
		<copy todir="${calc.dir}">
			<fileset dir="${project.dir}/.templates">
				<include name="*.gtt"/>
				<include name="*.gmt"/>
				<include name="*.gft"/>
				<include name="*.ott"/>
				<include name="*.odt"/>
				<include name="Zeitreihen/*.ott"/>
			</fileset>
		</copy>
 		
		<kalypso.changeGml gmlURL="${calc.url}/.calculation">
			<property featurepath="" featureProperty="scenarioId" value="${kalypso.currentScenarioId}"/>
			<property featurepath="" featureProperty="scenarioName" value="${kalypso.currentScenarioName}"/>
			<property featurepath="" featureProperty="scenarioDescription" value="${kalypso.currentScenarioDescription}"/>
			<property featurepath="" featureProperty="startforecast" value="${kalypso.startforecast}"/>
			<property featurepath="" featureProperty="editor" value="${kalypso.currentUser}"/>
			<property featurepath="" featureProperty="description" value="- bitte ausfüllen -"/>
			<property featurepath="" featureProperty="comment" value="- bitte ausfüllen -"/>
			<property featurepath="" featureProperty="calctime" value="${kalypso.currentTime}"/>
			<property featurepath="" featureProperty="mergeCasePath" value="${calc.merge.relpath}"/>
		</kalypso.changeGml>
 	</target>
	
 	<!-- - - - - - - - - - - - - - - - - - 
          target: calculationProperties                      Initializes properties from .calculation
         - - - - - - - - - - - - - - - - - -->
	 <target name="calculationProperties">
	   	<property name="HOURS_OF_DAY" value="11"/>

			<kalypso.gmlProperty gmlURL="${calc.url}/.calculation">
				<property name="startforecast" featurepath="" featureProperty="startforecast"/>
				<!-- startsim = startforecast - 15d (=360h)  -->
				<property name="startsim" featurepath="" featureProperty="startforecast" dateoffset="-360" dateoffsetfield="${HOURS_OF_DAY}" />
				<!-- stopsim = startforecast + 72h -->
				<property name="stopsim" featurepath="" featureProperty="startforecast" dateoffset="72" dateoffsetfield="${HOURS_OF_DAY}"/>
				<property name="scenarioId" featurepath="" featureProperty="scenarioId" defaultValue=""/>
				<property name="calc.merge.path" featurepath="" featureProperty="mergeCasePath" defaultValue=""/>
			</kalypso.gmlProperty>
	    	<echo message="Szenario der Rechenvariante ist: ${scenarioId}" />

	    	<!-- Construct the url of the calc case to merge and set the flag if merge is allowed.
	    		 REMARK: add trailing '/', else url resolution does not work properly for
	    		 the merge task
	    	-->
	    	<property name="calc.merge.url" value="${project.url}${calc.merge.path}/"/>
	    	<condition property="doMergeCase">
	    		<not>
	    			<equals trim="true" arg1="" arg2="${calc.merge.path}"/>
	    		</not>
	    	</condition>
	 	
	    	<!-- Unterscheide zwischen Katastrophentest und normalem Szenario -->
			<kalypso.multiequals arg1="${scenarioId}" arg2="test">
				<!-- Links fürs Abholen der Zeitreihen -->
				<property name="pegelMessungLink" valueThen="in1ObservationLink" valueElse="inObservationLink"/>
				<property name="ZwischengebieteLink" valueThen="in1ObservationLink" valueElse="inObservationLink"/>
				
				<!-- Links für die Ablage der Vorhersage-Zeitreihen -->
				<property name="vorhersageLinkNormal" valueThen="out5ObservationLink" valueElse="out2ObservationLink"/>
				<property name="vorhersageLinkOben" valueThen="out4ObservationLink" valueElse="out1ObservationLink"/>
				<property name="vorhersageLinkUnten" valueThen="out3ObservationLink" valueElse="outObservationLink"/>
			</kalypso.multiequals>
	 </target>
	 <!-- 
			 ================================= 
	          target: update			Zeitreihen aktualisieren
	         ================================= 
     -->
	 <target name="update" depends="calculationProperties" description="Aktualisiert eine Rechenvariante"> 
		<echo message="Zeitreihen aktualisieren: ${calc.dir}" />
		
		<copy todir="${calc.dir}/Zeitreihen">
			<fileset dir="${project.dir}/.templates/Zeitreihen">
				<include name="*.gmt"/>
				<include name="*.gtt"/>
				<include name="*.gft"/>
				<include name="*.ott"/>
				<include name="*.odt"/>
			</fileset>
		</copy>
	
	 	<!-- 
	 			Pegel 
	 	-->
	 	<!-- Zwischengebietspegel: nur Messung -->
	 	<kalypso.copyObservation gml="${project.url}/.model/observationConf/ZwischengebietspegelMapping.gml" featurePath="mappingMember" context="${calc.url}" targetObservation="outObservationLink" forecastFrom="${startforecast}" forecastTo="${stopsim}" description="Abholen der Messwerte der Zwischengebietspegel">
 			<source property="${pegelMessungLink}" from="${startsim}" to="${startforecast}" filter="${filterQ}"/>
 			<metadata name="Szenario" value="${scenarioId}"/>
 		</kalypso.copyObservation>
	 	
		<!-- leere Zeitreihen holen, damit was reingeschrieben werden kann...-->
	 	<!-- Das ist notwendig damit nach dem zusammendaddieren auch der Vorhersagezeitraum drin ist -->
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/ZwischengebieteMapping.gml" featurePath="mappingMember" context="${calc.url}" targetObservation="outObservationLink" forecastFrom="${startforecast}" forecastTo="${stopsim}" description="Vorlage Zwischengebietsabflüsse (kein Fehler)">
			<source property="${pegelMessungLink}" from="${startsim}" to="${stopsim}" filter="${filterQDefault0}"/>
			<metadata name="Szenario" value="${scenarioId}"/>
		</kalypso.copyObservation>
	 	
		 <!-- nach update immer Zwischengebietszuflüsse berechnen -->
		<antcall target="zwischengebietszufluesse" />
	 	
		<antcall target="mergeCase"/>
	 </target>
	
	
	<!-- 
		 ================================= 
          target: mergeCase			
         ================================= 
    -->
	<target name="mergeCase" if="doMergeCase">
	 	<!-- Zwischengebietspegel: nur Messung -->
	 	<kalypso.mergeObservation gml="${project.url}/.model/observationConf/ZwischengebietspegelMapping.gml" featurePath="mappingMember" context="${calc.url}" sourceContext="${calc.merge.url}" observationProperty="outObservationLink" description="Zusammenführen der Messwerte der Zwischengebietspegel"/>
	 	
		<!-- Leere Zwischengebiete -->
		<kalypso.mergeObservation gml="${project.url}/.model/observationConf/ZwischengebieteMapping.gml" featurePath="mappingMember" context="${calc.url}" sourceContext="${calc.merge.url}" observationProperty="outObservationLink" description="Zusammenführen der Zwischengebietsabflüsse"/>
	</target>
	
	
	 <!-- ================================= 
		          target: exportVorhersagen              
		  ================================= -->
 
	    <target name="exportVorhersagen" depends="calculationProperties" description="Export der Prognosen nach PSICompact">
	        <echo message="Vorhersagezeitreihen werden nach PSICompact geschrieben..."/>
	   		<echo message="Szenario-ID der Rechenvariante ist: ${scenarioId}" />
	   		<echo message="" />
	
	       <!-- Es müssen die gesamten Zeitreihen abgelegt werden! -->
	       	<echo message="Ablage der Rechenergebnisse"/>
	       	<kalypso.commitPrognoses context="${calc.url}" featurepath="${exportPrognosenFeaturePath}" gml="${project.url}/.model/observationConf/VorhersageMapping.gml" sourcefilter="${filterAblageQ}" localobs="local1" remoteobs="${vorhersageLinkNormal}" runasync="false" IgnoreIllegalFeaturePath="true"/>
	    </target>

	 <!-- ================================= 
		          target: zwischengebietszuflussUstiDresden              
          ================================= -->

	<target name="zwischengebietszuflussUstiDresden" depends="calculationProperties" description="Berechnet den Zwischengebietszufluss für Usti - Dresden"> 
		<kalypso.gmlWeight modelurl="${calc.url}/calcCase.gml" 
			               	featurepathtarget="#fid#UstiDresden" 
							propzmltarget="ganglinie_gesamt" 
							proprelationweightmember="" 
							propoffset="a"  
							propweight="b"
							proprelationsourcefeature="zuflussPegelMember" 
							propzmlsource="ganglinie_messwerte" 
							propsourceused="istSummand"
							sourcefilter="${filterWeight}"
							targetcontext="${calc.url}" 
							sourceFrom="${startsim}"
							sourceTo="${stopsim}"
							targetFrom="${startforecast}"
							targetTo="${stopsim}"
							forecastFrom="${startforecast}"
							forecastTo="${stopsim}"
			description="Berechnung des Zwischengebietszuflusses für Usti - Dresden"/>
	 </target>
	 <!-- ================================= 
		          target: zwischengebietszuflussDresdenTorgau              
          ================================= -->
	 <target name="zwischengebietszuflussDresdenTorgau" depends="calculationProperties" description="Berechnet den Zwischengebietszufluss für Dresden - Torgau">
		<kalypso.gmlWeight modelurl="${calc.url}/calcCase.gml" 
			               	featurepathtarget="#fid#DresdenTorgau" 
							propzmltarget="ganglinie_gesamt" 
							proprelationweightmember="" 
							propoffset="a"  
							propweight="b"
							proprelationsourcefeature="zuflussPegelMember" 
							propzmlsource="ganglinie_messwerte" 
							propsourceused="istSummand"
							sourcefilter="${filterWeight}"
							targetcontext="${calc.url}" 
							sourceFrom="${startsim}"
							sourceTo="${stopsim}"
							targetFrom="${startforecast}"
							targetTo="${stopsim}"
							forecastFrom="${startforecast}"
							forecastTo="${stopsim}"
			description="Berechnung des Zwischengebietszuflusses für Dresden - Torgau"/>
	 </target>
	 <!-- ================================= 
		          target: zwischengebietszufluss              
         ================================= -->
	 <target name="zwischengebietszufluesse" depends="calculationProperties" description="Berechnet die Zwischengebietszuflüsse">
	  <antcall target="zwischengebietszuflussUstiDresden"/>
	  <antcall target="zwischengebietszuflussDresdenTorgau"/>
	 </target>
	
	 <!-- ================================= 
		          target: runCalculation. Target der Vollständigkeit halber eingeführt, damit im Expertenmodus Modell -> Berechnen ausgeführt werden kann              
         ================================= -->
	 <target name="runCalculation" depends="zwischengebietszufluesse" description="Berechnet die Zwischengebietszuflüsse">
	 </target>
</project>
