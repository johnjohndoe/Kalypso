<?xml version="1.0" encoding="UTF-8"?>
<section id="wiski" vendor="sachsen-anhalt">
  <title>WISKI/WebDataProvider</title>

  <para>Alle von KALYPSO benötigten Zeitreihendaten werden innerhalb des
  Hochwasserzentrums von WISKI geliefert bzw. alle Ergebnisse in Form von
  Zeitreihen nach WISKI zurück geschrieben. Der Zugriff auf die WISKI Daten
  erfolgt aus Sicht von KALPYSO über den von der KistersAG gestellten
  WISKI-WebDataProvider (WDP).</para>

  <section>
    <title>Überblick</title>

    <para>Entsprechend der beiden WISKI Instanzen in Magdeburg und Halle sind
    auch zwei WDP-Instanzen auf den Rechnern <filename>smdhvlapp</filename>
    und <filename>shalhvzlapp</filename> installiert. Der Aufruf erfolgt über
    Java-RMI (Remote Method Invocation), jeweils Port 10991.</para>

    <para>Der Aufruf des WDP erfordert gernerell eine Authentifizierung. Für
    den Zugriff seitens KALYPSO wurde hierzu ein separater Benutzer namens
    'wdpuser' eingerichtet.</para>

    <para><xref linkend="tbl_wdp_methoden" /> fasst die Anwendung der WDP
    Schnittstelle aus der Sicht von KALYPSO zusammen.</para>

    <table id="tbl_wdp_methoden">
      <title>Benutzte Methoden der WDP-Schnittstelle</title>

      <tgroup cols="2">
        <colspec align="left" colwidth="1*" />

        <colspec align="left" colwidth="2*" />

        <thead>
          <row>
            <entry align="center">WISKI</entry>

            <entry align="center">KALYPSO - Beschreibung</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>getSuperGroupList</entry>

            <entry>Liste der WISKI-Gruppenarten ermitteln. Dient zum Aufbau
            der IRepository Struktur in KALYPSO.</entry>
          </row>

          <row>
            <entry>getGroupList</entry>

            <entry>Liste der WISKI-Gruppen ermitteln. Dient zum Aufbau der
            IRepository Struktur in KALYPSO.</entry>
          </row>

          <row>
            <entry>getTsInfoList</entry>

            <entry>Liste der Zeitreihen ermitteln.</entry>
          </row>

          <row>
            <entry>getAlarmLevelList</entry>

            <entry>Alarmstufen abfragen.</entry>
          </row>

          <row>
            <entry>getRatingTables</entry>

            <entry>W/Q und W/V Beziehungen abfragen.</entry>
          </row>

          <row>
            <entry>getStationDetailList</entry>

            <entry>Metadaten abfragen.</entry>
          </row>

          <row>
            <entry>getTsData</entry>

            <entry>Zeitreihendaten abholen.</entry>
          </row>

          <row>
            <entry>IsTsWritable</entry>

            <entry>Prüfen, ob Daten einer Zeitreihe zurückgeschrieben werden
            können.</entry>
          </row>

          <row>
            <entry>setTsData</entry>

            <entry>Zeitreihendaten zurückschreiben.</entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </section>

  <section>
    <title>Implementierung</title>

    <para>Die Implementierung in KALYPSO basiert auf dem IRepository-Framework
    (siehe Java-Interface
    <interfacename>org.kalypso.repository.IRepository</interfacename>).</para>

    <para>Die Schnittstelle wird nur serverseitig benutzt.</para>

    <para>Die Firma Kisters hat die Funktionen des WDP über eine
    Java-Bilbiothek zur Verfügung gestellt. Aus dem Namensraum
    <classname>de.kisters.wiski.webdataprovider</classname> sind alle WDP
    Klassen zu erreichen.</para>
  </section>

  <section>
    <title>Konfiguration</title>

    <para>Die Grundkonfiguration des Zugriffs auf den WDP erfolgt über die
    Konfiguration des Zeitreihendienstes im Verzeichnis
    <filename>//smdhvzwapp/d/kalypso/Tomcat5.0/webapps/webdav/srvconf/IObservationService</filename>.
    In der Datei <filename>repconf_server.xml</filename> wird dort das
    WISKI-Repository eingebunden und der Zugriff auf die oben genannten
    Rechner und Ports konfiguriert (siehe auch <xref
    linkend="chapter_4_zeitreihen" /> und <xref
    linkend="install-server_services_config" />).</para>

    <para>Daneben ist die Implementierung der KALYPSO-WDP Schnittstelle über
    eine Konfigurationsdatei anpassbar (siehe
    <filename>org/Kalypso/wiskiadapter/resources/config.ini</filename>). Dort
    sind die möglichen Parameter aufgelistet und beschrieben. Siehe auch die
    <xref linkend="abb_wdp_konfig1" /> und <xref
    linkend="abb_wdp_konfig2" />:</para>

    <figure id="abb_wdp_konfig1">
      <title>Konfiguration 1</title>

      <mediaobject>
        <imageobject>
          <imagedata fileref="img/kap11/Konfiguration_1.png" scale="70" />
        </imageobject>
      </mediaobject>
    </figure>

    <figure id="abb_wdp_konfig2">
      <title>Konfiguration 2</title>

      <mediaobject>
        <imageobject>
          <imagedata fileref="img/kap11/Konfiguration_2.png" scale="70" />
        </imageobject>
      </mediaobject>
    </figure>
  </section>

  <section>
    <title>Laufzeit</title>

    <para>Zur Laufzeit wird die von der KistersAG gelieferte Java-Bibliothek
    <filename>kiwwebdp-externalclient.jar</filename> benötigt und im
    Lib-Verzeichnis des Projekts KalypsoAdapterWiski abgelegt. Da RMI
    standardmäßig mit dem JDK geliefert wird, werden hierzu keine weiteren
    Bibliotheken benötigt.</para>

    <para>Da Tomcat im Sicherheitsmodus gestartet wird, sind entsprechende
    Einträge für die WDP-Codebase notwendig. Die Datei
    <filename>catalina.policy</filename> beinhaltet einen speziellen Bereich
    für WDP (siehe <filename>catalina.policy</filename> im
    <filename>conf</filename>-Verzeichnis von Tomcat).</para>
  </section>

  <section>
    <title>Zeitreihen</title>

    <para>WISKI liefert definierte Statuswerte zu den Werten einer Zeitreihe.
    Diese müssen auf die innerhalb von KALYPSO benutzten Stati abgebildet
    werden. Die Umwandlung der Status-Information erfolgt beim Abruf der Daten
    aus WISKI in folgender Weise:</para>

    <informaltable id="tbl_11_06_zeitreihen">
      <tgroup cols="2">
        <colspec align="left" colwidth="1*" />

        <colspec align="left" colwidth="1*" />

        <thead>
          <row>
            <entry align="center">WISKI</entry>

            <entry align="center">KALYPSO</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>GOOD</entry>

            <entry>OK</entry>
          </row>

          <row>
            <entry>ESTIMATED</entry>

            <entry>Wert auf Gültigkeit prüfen</entry>
          </row>

          <row>
            <entry>SUSPECT</entry>

            <entry>Wert auf Gültigkeit prüfen</entry>
          </row>

          <row>
            <entry>UNCHECKED</entry>

            <entry>OK</entry>
          </row>

          <row>
            <entry>MISSING</entry>

            <entry>Wert auf Gültigkeit prüfen</entry>
          </row>

          <row>
            <entry>COMPLETE</entry>

            <entry>OK</entry>
          </row>

          <row>
            <entry>INCOMPLETE</entry>

            <entry>Wert auf Gültigkeit prüfen</entry>
          </row>
        </tbody>
      </tgroup>
    </informaltable>

    <para>Wenn Simulations-Zeitreihen von KALYPSO nach WISKI zurückgeschrieben
    werden, bekommen sie automatisch den Status GOOD.</para>
  </section>

  <section>
    <title>WDP-Login</title>

    <para>Die WDP-Schnittstelle der KistersAG wurde speziell fürs Internet
    entwickelt, um eine Interaktion zwischen Benutzer und WISKI per Browser zu
    ermöglichen. Dabei wird ein Login/Logout Mechanimus verwendet, welcher
    einen automatischen Logout nach einer bestimmten Zeit vorsieht.</para>

    <para>Die Anwendung dieser Schnittstelle in KALYPSO stellt dagegen eine
    andere Art von Interaktion zwischen den beiden Systemen dar. Die WDP-SST
    wird direkt vom KALYPSO Observation Dienst über einen festgelegten
    Benutzer ('wdpuser') benutzt, ohne Authentifizierung gegen den
    tatsächlichen angemeldeten Benutzer. Das heisst, der KALYPSO Observation
    Dienst meldet sich beim Start an dem WDP an und meldet sich nur in
    bestimmten Fällen ab:</para>

    <itemizedlist>
      <listitem>
        <para>beim Stoppen des Dienstes</para>
      </listitem>

      <listitem>
        <para>beim Stoppen des Server.</para>
      </listitem>
    </itemizedlist>

    <para>Wann dies tatsächlich passiert ist dabei nicht vorhersehbar. Das
    bedeutet, dass ein automatischer Logout durch den WDP nicht ausgeschlossen
    werden kann.</para>

    <para>Um vor dieser Art von Logout zu schützen wurde der KALYPSO
    Observation Dienst so implementiert, dass stets ein automatischer
    Login-Versuch bei jedem Zugriff erfolgt. Dadurch ist die Verbindung
    zwischen KALYPSO und WDP ohne Ausfall garantiert, vorrausgesetzt die
    Systeme stehen zur Verfügung. Diese Vorgehensweise wurde in der Kodierung
    durch eine anfrageorientierte Verwaltung der WDP-Aufrufe berücksichtigt
    (siehe lWiskiCall und WiskiRepository. executeWiskiCall).</para>
  </section>

  <section>
    <title>Caching Mechanismus von W/Q-artigen Beziehungen</title>

    <para>Um den Betrieb von KALYPSO auch beim Ausfall von WISKI zumindest
    grundsätzlich (d.h. per Handeingabe der Zeitreihenwerte) zu ermöglichen,
    ist es seitens KALYPSO nötig, stets auf die W/Q- (oder W/V-) Beziehungen
    der Messreihen zugreifen zu können.</para>

    <para>Zu diesem Zweck werden bei stets die zuletzt aus WISKI gelesenen
    W/Q- oder W/V-Beziehungen als Datei auf dem KALYPSO Server gespeichert
    ('gecached'). Sollte WISKI nicht mehr zur Verfügung stehen, wird die
    abgespeicherte Datei benutzt.</para>

    <para>Hierzu wurde speziell die WiskiObservationManipulator Klasse
    erstellt. Sie wird vom KalypsoObservationDienst benutzt, über Reflektion
    instanziert, und in der Konfigurationsdatei des Observation-Dienstes
    konfiguriert. Konfigurationsausschnitt:</para>

    <figure>
      <title>Caching-Mechanismus von W/Q-Beziehungen</title>

      <mediaobject>
        <imageobject>
          <imagedata fileref="img/kap11/Caching_Mechanismus.png" scale="70" />
        </imageobject>
      </mediaobject>
    </figure>

    <para>Die Ablage der zwischengespeicherten W/Q bzw. W/V Beziehungen
    erfolgt im Verzeichnis
    <filename>//smdhvzwapp/D/kalypso/Tomcat5.0/temp/wiskiRatingTables</filename>.</para>
  </section>

  <section>
    <title>Zeitzonen</title>

    <para>Damit die Zeitreihen einheitlich zwischen WISKI und KALYPSO
    angezeigt werden, wurde die Einstellung der Zeitzone (auch eine
    Eigenschaft der Konfiguration des Observation-Dienstes) auf GMT1 gesetzt.
    WISKI arbeitet immer in Winterzeit.</para>
  </section>
</section>