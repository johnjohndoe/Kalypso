<?xml version="1.0" encoding="UTF-8"?>
<section id="wiski" vendor="sachsen-anhalt">
  <title>Schnittstelle zu WISKI/WebDataProvider</title>

  <para>Die Schnittstelle zwischen KALYPSO und WISKI/WebDataProvider (WDP)
  wird im Projekt KalypsoAdapterWiski implementiert. Damit werden Zeitreihen
  aus WISKI abgeholt und Simulations-Zeitreihen nach WISKI zurück
  geschrieben.</para>

  <section>
    <title>Überblick</title>

    <para><xref linkend="tbl_wdp_methoden" /> fasst die Anwendung der WDP
    Schnittstelle aus KALYPSO-Sicht zusammen. Die Aufrufe erfolgen über
    Java-RMI (Remote Method Invocation).</para>

    <table id="tbl_wdp_methoden">
      <title>Benutzte Methoden der WDP-Schnittstelle</title>

      <tgroup cols="2">
        <colspec align="left" colwidth="1*" />

        <colspec align="left" colwidth="2*" />

        <thead>
          <row>
            <entry align="center">WISKI</entry>

            <entry align="center">KALYPSO - Beschreibung</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>getSuperGroupList</entry>

            <entry>Liste der WISKI-Gruppenarten ermitteln. Dient zum Aufbau
            der IRepository Struktur in KALYPSO.</entry>
          </row>

          <row>
            <entry>getGroupList</entry>

            <entry>Liste der WISKI-Gruppen ermitteln. Dient zum Aufbau der
            IRepository Struktur in KALYPSO.</entry>
          </row>

          <row>
            <entry>getTsInfoList</entry>

            <entry>Liste der Zeitreihen ermitteln.</entry>
          </row>

          <row>
            <entry>getAlarmLevelList</entry>

            <entry>Alarmstufen abfragen.</entry>
          </row>

          <row>
            <entry>getRatingTables</entry>

            <entry>W/Q und W/V Beziehungen abfragen.</entry>
          </row>

          <row>
            <entry>getStationDetailList</entry>

            <entry>Metadaten abfragen.</entry>
          </row>

          <row>
            <entry>getTsData</entry>

            <entry>Zeitreihendaten abholen.</entry>
          </row>

          <row>
            <entry>IsTsWritable</entry>

            <entry>Prüfen, ob Daten einer Zeitreihe zurückgeschrieben werden
            können.</entry>
          </row>

          <row>
            <entry>setTsData</entry>

            <entry>Zeitreihendaten zurückschreiben.</entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </section>

  <section>
    <title>Quellcode</title>

    <para>Die Implementierung in KALYPSO basiert auf dem IRepository-Framework
    (siehe Java-Interface org.Kalypso.repository.IRepository). Die
    Schnittstelle wird nur serverseitig benutzt.</para>

    <para>Die Firma Kisters hat die Funktionen des WDP über eine
    Java-Bilbiothek zur Verfügung gestellt. Aus dem Namensraum
    <filename>de.kisters.wiski.webdataprovider</filename> sind alle WDP
    Klassen zu erreichen.</para>
  </section>

  <section>
    <title>Konfiguration</title>

    <para>Die Implementierung der KALYPSO-WDP Schnittstelle ist über eine
    Konfigurationsdatei anpassbar (Siehe in
    <filename>org/Kalypso/wiskiadapter/resources/config.ini</filename>). Dort
    sind die möglichen Parameter aufgelistet und beschrieben. Siehe auch die
    <xref linkend="abb_wdp_konfig1" /> und <xref
    linkend="abb_wdp_konfig2" />:</para>

    <figure id="abb_wdp_konfig1">
      <title>Konfiguration 1</title>

      <mediaobject>
        <imageobject>
          <imagedata fileref="img/kap11/Konfiguration_1.png" scale="70" />
        </imageobject>
      </mediaobject>
    </figure>

    <figure id="abb_wdp_konfig2">
      <title>Konfiguration 2</title>

      <mediaobject>
        <imageobject>
          <imagedata fileref="img/kap11/Konfiguration_2.png" scale="70" />
        </imageobject>
      </mediaobject>
    </figure>
  </section>

  <section>
    <title>Besonderheiten</title>

    <para>Aus der Implementierung der Schnittstelle für die HVZ sind folgende
    Besonderheiten entstanden.</para>

    <section>
      <title>WDP-Login</title>

      <!--verstehe ich (Monika) nicht...-->

      <para>Die WDP-Schnittstelle von Kisters wurde speziell fürs Web
      entwickelt, wo eine Interaktion zwischen Benutzer/Browser Applikation
      und WISKI ein Login/Logout Mechanimus mit automatisches Logout nach
      einen bestimmten Zeit vorsieht. Die Anwendung dieser Schnittstelle in
      KALYPSO steift aber eine andere Art von Interaktion zwischen beide
      Systemen dar Login/Logout, aber ohne Timeout. Die WDP-SST wird nämlich
      direkt vom KALYPSO Observation Dienst benutzt, ohne Unterschied zwischen
      den tatsächlichen angemeldeten Benutzer. Das heisst, der KALYPSO
      Observation Dienst meldet sich beim Start an dem WDP an und meldet sich
      nur in bestimmten Fällen ab:</para>

      <itemizedlist>
        <listitem>
          <para>beim Stoppen der Dienst</para>
        </listitem>

        <listitem>
          <para>beim Stoppen der Server</para>
        </listitem>
      </itemizedlist>

      <para>und wann dies tatsächlich passiert ist nicht vorhersehbar Das
      bedeutet das ein automatisches Logout, durch den WDP vorangetrieben,
      nicht ausgeschlossen werden kann.</para>

      <para>Der KALYPSO Observation Dienst wurde gegen einen solchen Art von
      Logout dementsprechend vorbereitet, indem er automatisch versucht, sich
      wieder einzuloggen. Dadurch ist die Verbindung zwischen KALYPSO und WDP
      stets ohne Ausfall garantiert, vorrausgesetzt die Systeme stehen zur
      Verfügung.</para>

      <para>Dies wurde im Code durch das Anfrage orientierte Verwaltung der
      WDP-Aufrufe berücksichtigt (Siehe lWiskiCall und WiskiRepository.
      executeWiskiCall).</para>
    </section>

    <section>
      <title>Caching Mechanismus von W/Q-artigen Beziehungen</title>

      <para>Die aktuellen aus WISKI gelesenen W/Q- oder W/V-Beziehungen werden
      als Datei gespeichert. Sollte WISKI nicht mehr zur Verfügung stehen,
      wird die abgespeicherte Datei benutzt. Dies dient zu Datenverfügbarkeit
      im Falle eines Ausfall.</para>

      <para>Dazu wurde speziell die WiskiObservationManipulator Klasse
      erstellt. Sie wird vom KalypsoObservationDienst benutzt, über Reflektion
      instanziert, und in der Konfigurationsdatei des Observation-Dienstes
      konfiguriert. Konfigurationsausschnitt:</para>

      <figure>
        <title>Caching-Mechanismus von W/Q-Beziehungen</title>

        <mediaobject>
          <imageobject>
            <imagedata fileref="img/kap11/Caching_Mechanismus.png" scale="70" />
          </imageobject>
        </mediaobject>
      </figure>
    </section>

    <section>
      <title>Zeitzonen-Problematik</title>

      <para>Damit die Zeitreihen einheitlich zwischen WISKI und KALYPSO
      angezeigt werden, wurde die Einstellung der Zeitzone (auch eine
      Eigenschaft der Konfiguration des Observation-Dienstes) auf GMT1
      gesetzt. WISKI arbeitet immer in Winterzeit.</para>
    </section>
  </section>

  <section>
    <title>Laufzeit</title>

    <para>Zur Laufzeit wird die Java-Bibliothek
    <filename>kiwwebdp-externalclient.jar</filename> benötigt und im
    Lib-Verzeichnis des Projekts KalypsoAdapterWiski abgelegt. Da RMI
    standardmäßig mit dem JDK geliefert wird, werden hierzu keine spezielle
    Abhängigkeiten benötigt.</para>

    <para>Da Tomcat im Sicherheitsmodus gestartet wird, sind entsprechende
    Einträge für die WDP-Codebase notwendig. Die Datei
    <filename>catalina.policy</filename> beinhaltet einen speziellen Bereich
    für WDP (siehe <filename>catalina.policy</filename> im
    <filename>conf</filename>-Verzeichnis von Tomcat).</para>
  </section>

  <section>
    <title>Zeitreihen</title>

    <para>WISKI liefert definierte Statuswerte zu den Werten einer Zeitreihe.
    Diese müssen auf die innerhalb von KALYPSO benutzten Stati abgebildet
    werden. Die Umwandlung der Status-Information erfolgt beim Abruf der Daten
    aus WISKI in folgender Weise:</para>

    <informaltable id="tbl_11_06_zeitreihen">
      <tgroup cols="2">
        <colspec align="left" colwidth="1*" />

        <colspec align="left" colwidth="1*" />

        <thead>
          <row>
            <entry align="center">WISKI</entry>

            <entry align="center">KALYPSO</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>GOOD</entry>

            <entry>OK</entry>
          </row>

          <row>
            <entry>ESTIMATED</entry>

            <entry>Wert auf Gültigkeit prüfen</entry>
          </row>

          <row>
            <entry>SUSPECT</entry>

            <entry>Wert auf Gültigkeit prüfen</entry>
          </row>

          <row>
            <entry>UNCHECKED</entry>

            <entry>OK</entry>
          </row>

          <row>
            <entry>MISSING</entry>

            <entry>Wert auf Gültigkeit prüfen</entry>
          </row>

          <row>
            <entry>COMPLETE</entry>

            <entry>OK</entry>
          </row>

          <row>
            <entry>INCOMPLETE</entry>

            <entry>Wert auf Gültigkeit prüfen</entry>
          </row>
        </tbody>
      </tgroup>
    </informaltable>

    <para>Wenn Simulations-Zeitreihen von KALYPSO nach WISKI zurückgeschrieben
    werden, bekommen sie automatisch den Status GOOD.</para>
  </section>
</section>