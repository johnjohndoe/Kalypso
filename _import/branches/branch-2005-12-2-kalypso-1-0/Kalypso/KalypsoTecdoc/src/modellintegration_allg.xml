<?xml version="1.0" encoding="UTF-8"?>
<section id="chapter_7_modellintegration">
  <title>Modellintegration</title>

  <para>Das Programmsystem KALYPSO ist in der Lage, eine Vielzahl
  verschiedenartiger Modelle unter einer einheitlichen Benutzeroberfläche zu
  integrieren. Die Integration eines neuen Modelltyps (eines neuen
  Rechenkerns) erfolgt dabei auf zwei Ebenen.</para>

  <para>Serverseitig wird das Modell (bzw. der Rechenkern) über eine
  feststehende Java-Schnittstelle implementiert, denn hier erfolgt die für den
  jeweiligen Rechenkern spezifische Programmierung wie z.B.: Anstoßen des
  nativen Programms (.exe), Lesen und Schreiben der speziellen Formate.</para>

  <para>Clientseitig werden alle Modelle gleichermaßen behandelt, sie
  unterscheiden sich lediglich in ihrer Datenspezifikation. Aus diesem Grund
  ist es nötig, die Modelldaten formal mit Hilfe von GML-Schemata zu
  spezifizieren.</para>

  <para>Über diese beiden Grundbausteine (Modell-Plugin und
  Datenspezifikation) hinaus gibt es noch eine Reihe von
  Konfigurationsdateien, welche bestimmte Programmabläufe wie zum Beispiel
  <guilabel>Anlegen einer Rechenvariante</guilabel> und den Vorhersage-Wizard
  steuern.</para>

  <para>Im Weiteren wird die Konfiguration dieser Modellintegration in der von
  uns empfohlenen Reihenfolge im Detail beschrieben.</para>

  <section>
    <title>Modellspezifikation und Grunddaten</title>

    <formalpara>
      <title>MODELL-PROJEKT</title>

      <para>Bevor mit der Spezifikation begonnen werden kann, muss im
      KALYPSO-Arbeitsbereich (<guilabel>Navigator</guilabel>) ein neues,
      leeres Projekt über <guimenuitem>Datei-Neu</guimenuitem> angelegt
      werden. Das neue Projekt enthält lediglich die Datei
      <filename>.project</filename>, welche jetzt um die Zeile
      &lt;nature&gt;org.Kalypso.ui.ModelNature&lt;/nature&gt; Im Unterpunkt
      &lt;natures&gt; ergänzt werden muss, um es als KALYPSO-Modell-Projekt zu
      kennzeichnen. Neue Dateien und Verzeichnisse können im Projekt ebenfalls
      über den Menüpunkt <guimenuitem>Datei-Neu</guimenuitem> erstellt
      werden.</para>
    </formalpara>

    <formalpara>
      <title>SPEZIFIKATION</title>

      <para>Die Spezifikation der Modell-(Grund-)Daten erfolgt in Form von XML
      Schemata (*.xsd). Die Spezifikation muss konform zum OGC GML2 Standard
      erfolgen (siehe auch <xref linkend="abschn_5_2" />). Die Ablage der .xsd
      Dateien ist frei wählbar, wir empfehlen die Ablage unter
      /.model/schemata/. Ebenfalls frei wählbar ist, ob die
      Modellspezifikation in einer einzelnen Datei abgelegt ist oder auf
      mehrere Dateien verteilt wird. Verweise (Importe) der Schemata
      untereinander sollten immer mit relativen Pfaden erfolgen.</para>
    </formalpara>

    <formalpara>
      <title>MODELL-DATEN</title>

      <para>Nach der Spezifikation der Modell-Daten können bereits die
      Modelldaten in Form einer .gml Datei erstellt werden. Diese muss
      natürlich gegen die .xsd Schematas validieren. Die Modelldaten können
      dabei so angelegt werden, dass alle Daten in einer einzelnen .gml Datei
      abgelegt oder alternativ über mehrere Dateien verteilt werden. Je nach
      Größe des Modells kann es sinnvoll sein, die Modelldaten aus bestehenden
      Modelldaten automatisch generieren zu lassen. Hierzu wird natürlich eine
      spezielle Programmierung benötigt.</para>
    </formalpara>

    <formalpara>
      <title>VORLAGEN</title>

      <para>Liegen die Modelldaten bereits teilweise vor, können jetzt schon
      Karten- und Tabellenvorlagen, die auf die Modellgrunddaten zugreifen,
      erstellt werden. Es empfiehlt sich, die Vorlagen möglichst frühzeitig
      anzulegen, um eventuelle Fehler in den Daten bzw. der Datenmodellierung
      rechtzeitig zu erkennen. Darüber hinaus können die Vorlagen natürlich
      auch zur Eingabe der Modellgrunddaten verwendet werden. Neben den
      (GIS-basierten) Modelldaten können weitere im Projekt abgelegte
      GIS-Daten visualisiert werden (z.B. ESRI Shapes). Die Ablage der
      Modelldaten ist zwar im Wesentlichen frei wählbar, sollte aber dennoch
      nach einem festen Schema erfolgen (siehe <xref linkend="abschn_5_1" />
      ).</para>
    </formalpara>
  </section>

  <section>
    <title>Spezifikation der Rechenvarianten</title>

    <para>Nach dem Erstellen der Grunddaten besteht der nächste Schritt darin,
    die Konfiguration der Rechenvarianten zu definieren. Eine Rechenvariante
    besteht dabei stets aus einem Unterverzeichnis des Projektes, welches
    durch Vorhandensein der Datei `.calculation’ als solches gekennzeichnet
    ist. Die Datei `.calculation’ enthält dabei die für die Berechnung
    benötigten Steuerdaten, insbesondere den Zeitraum der Modellrechnung,
    welcher für den Import von Zeitreihen aus dem Zeitreihen-Dienst benötigt
    wird.</para>

    <formalpara>
      <title>.CALCULATION</title>

      <para>Die Datei `.calculation’ ist eine Datei im GML Format, welche beim
      Erzeugen einer Rechenvariante automatisch angezeigt wird. Zu diesem
      Zweck muss als Vorlage eine Datei `.calculation.template’ im Verzeichnis
      /.model/ des Projektes angelegt sein. Die Vorlage wird beim Erstellen
      einer Rechenvariante automatisch in das neue Verzeichnis übernommen und
      mittels der Standard-Feature-Ansicht visualisiert. Dabei können durch
      Vergabe von Platzhaltern bestimmte Felder automatisch vorbelegt werden.
      Folgende Platzhalter sind definiert: <itemizedlist>
          <listitem>
            <para>:startsim: Vorgeschlagener Startpunkt der Simulation</para>
          </listitem>

          <listitem>
            <para>:startforecast: Vorgeschlagener Startpunkt der Vorhersage
            (Ist-Zeitpunkt)</para>
          </listitem>

          <listitem>
            <para>:endsim: Vorgeschlagener Endpunkt der Simulation</para>
          </listitem>

          <listitem>
            <para>:user: Anmeldename des Benutzers</para>
          </listitem>
        </itemizedlist> Soll die Anzeige der .calculation (=zweite Seite des
      Wizards zur Erzeugung einer Rechenvariante - Menü „Rechenvariante-Neu“)
      eine spezielle Formatierung erhalten, kann auch eine Vorlagendatei im
      .gft Format unter dem Namen .calculation.view im /.model/ Verzeichnis
      abgelegt werden. Diese wird dann zur Visualisierung herangezogen.</para>
    </formalpara>

    <formalpara>
      <title>CALCCASECONFIG.XML</title>

      <para>Die Datei calcCaseConfig.xml, die im Verzeichnis /.model/ des
      Projektes gespeichert sein muss, beschreibt Aktionen, welche beim
      Erstellen bzw. Aktualisieren einer Rechenvariante durchgeführt werden.
      Jeder dieser Blöcke besteht dabei aus einer Reihe von sogenannten
      Transformationen, welche die einzelnen Aktionen (z.B. Kopieren von
      Dateien, Import von Zeitreihen vom Zeitreihen-Dienst) definieren. Die
      genaue Struktur der Datei calcCaseConfig.xml ergibt sich aus ihrer
      Schema-Definition calcCaseconfig.xsd. Eine Liste der zur Zeit
      implementierten Transformationen und ihrer Argumente befindet sich im
      Anhang. Falls andere Transformationen benötigt werden, können diese
      durch Implementation des Java-Interfaces
      org.Kalypso.util.transformation.ITransformation programmiert werden. Es
      empfiehlt sich, beim Erstellen der Rechenvariante alle zur Berechnung
      benötigten Daten in das Verzeichnis der Rechenvariante zu kopieren. Im
      gleichen Schritt können auch die Vorlagen zum Editieren der Daten
      kopiert bzw. erzeugt werden.</para>
    </formalpara>
  </section>

  <section>
    <title>Modell-Plugin</title>

    <para>Mit den letzten beiden Punkten ist die clientseitige Konfiguration
    fast abgeschlossen. Zum Anstoßen einer (serverseitigen) Berechnung wird im
    Projektverzeichnis aber noch die Information benötigt, welche Dateien zum
    Rechenkern übertragen werden. Diese Angabe muss in der Datei
    `modelspec.xml’ im Verzeichnis /.model/ abgelegt werden.</para>

    <para>Format und Beschreibung dieser Datei kann ihrem Schema
    (modelspec.xsd, in den Programmquellen unter
    <filename>/KalypsoCore/etc/schemas/model/</filename>) entnommen werden. Im
    Wesentlichen enthält diese Datei die Liste der Dateien, die zum Start
    einer Rechnung zum Server übertragen werden, jeweils mit einer eindeutigen
    Kennung (ID).</para>

    <formalpara>
      <title>PLUGIN</title>

      <para>Das serverseitige Modell-Plugin wird realisiert, indem das
      Java-Interface
      <filename>org.Kalypso.services.calculation.job.ICalcJob</filename>
      implementiert wird (siehe auch JavaDoc des Interface). Im Falle einer
      Berechnung wird die Methode <guilabel>run</guilabel> der jeweiligen
      Implementation eines Modelltyps aufgerufen. Dieser Methode wird unter
      anderem eine Liste der (jetzt serverseitig gespeicherten)
      Eingangsdateien übergeben. Nach Beenden der <guilabel>run</guilabel>
      -Methode werden über <guilabel>getResults</guilabel> die Ergebnisse der
      Berechnung abgerufen. Ist das Berechnungs-Interface implementiert, muss
      dieses noch in der Konfigurationsdatei des Berechnungs-Dienstes
      angemeldet werden und steht dann für Berechnungen des gewünschten
      Modelltyps zur Verfügung.</para>
    </formalpara>
  </section>

  <section>
    <title>Wizard-Konfiguration</title>

    <para>Die bislang geschilderte Methode beschreibt ausschließlich die
    Datenmodellierung und Integration im Expertenmodus.</para>

    <para>Um die Funktionen des Vorhersage-Wizards zur vereinfachten
    Benutzerführung nutzen zu können, muss im Projektverzeichnis /.model/ die
    Datei calcWizard.xml angelegt werden. Die Datei besteht dabei aus einer
    Liste der zu verwendenden Wizard-Seiten sowie deren
    Parametrisierung.</para>

    <para>Eine Auflistung der bisher zur Verfügung stehenden Seiten-Typen
    findet sich im Anhang. Werden spezielle, nicht vorhandene Wizard-Seiten
    benötigt, können weitere durch Implementierung des Java-Interfaces
    org.Kalypso.ui.calcwizard.modelpages.modelWizardPage zum Programm
    hinzugefügt werden.</para>

    <para>Die beiden ersten Seiten des Wizards <guilabel>Vorhersage
    erzeugen</guilabel> und <guilabel>Steuerparameter</guilabel> sind dabei in
    jedem Vorhersage-Wizard vorhanden und sind nicht konfigurierbar.</para>
  </section>

  <section>
    <title>Zusammenfassung/Checkliste</title>

    <para>Zusammengefasst müssen die folgenden Schritte durchgeführt
    werden:</para>

    <itemizedlist>
      <listitem>
        <para>Projekt anlegen und .project editieren</para>
      </listitem>

      <listitem>
        <para>Modellschemata und Modelldaten erzeugen</para>
      </listitem>

      <listitem>
        <para>Karten-/Tabellen-Vorlagen für Grunddaten erstellen</para>
      </listitem>

      <listitem>
        <para>Dateien .calculation.template und .calculation.view
        erzeugen</para>
      </listitem>

      <listitem>
        <para>Datei calcCaseConfig.xml erzeugen</para>
      </listitem>

      <listitem>
        <para>Karten-/Tabellen-/Zeitreihen-Vorlagen für Rechenvarianten
        erstellen</para>
      </listitem>

      <listitem>
        <para>Datei modelspec.xml erzeugen</para>
      </listitem>

      <listitem>
        <para>Implementation des Modell-Plugin Interfaces IcalcJob</para>
      </listitem>

      <listitem>
        <para>Konfiguration des Rechendienst-Servers</para>
      </listitem>

      <listitem>
        <para>Datei calcWizard.xml erzeugen</para>
      </listitem>

      <listitem>
        <para>Vorlagen für Wizard-Seiten erstellen</para>
      </listitem>
    </itemizedlist>
  </section>
</section>