<project default="fake">

    <property name="modell.template.dir" value="${project.dir}/.templates/Modell" />

    <!-- - - - - - - - - - - - - - - - - - 
          target: fake                      nur damit das Projekt nicht schreit
      - - - - - - - - - - - - - - - - - -->
    <target name="fake" />

    <target name="info">
        <echo message="" />
        <echo message=" project dir ${project.dir}" />
        <echo message=" project url ${project.url}" />
        <echo message=" calc dir    ${calc.dir}" />
        <echo message=" calc url    ${calc.url}" />
        <echo message="" />
    </target>


    <!-- 
		 ================================= 
          target: create			Rechenvariante erzeugen
         ================================= 
    -->

    <target name="create" description="Erzeugt eine Rechenvariante">
        <echo message="Rechenvariante anlegen: ${calc.dir}" />
        <!-- copy modell -->
        <copy file="${project.dir}/modell.gml" tofile="${calc.dir}/calcCase.gml" />
        <copy file="${project.dir}/ombrometer.gml" tofile="${calc.dir}/ombrometer.gml" />
        <copy file="${project.dir}/.model/observationConf/ObsTMapping.gml"
              tofile="${calc.dir}/.obsT.gml" />
        <!-- copy others -->
        <copy todir="${calc.dir}">
            <fileset dir="${project.dir}/.templates/calcCase/copy"
                     includes="*/**"
                     excludes="**/CVS/**" />
        </copy>
    </target>

    <target name="setProperties" depends="info">
        <echo message="Variablen einrichten" />
        <kalypso.gmlProperty gmlURL="${calc.url}/.calculation">
            <property name="scenarioId"
                      featurepath=""
                      featureProperty="scenarioId"
                      defaultValue="" />
            <property name="startsim" featurepath="/" featureProperty="startsimulation" />
            <property name="startforecast" featurepath="/" featureProperty="startforecast" />
            <property name="hoursofforecast" featurepath="/" featureProperty="hoursforecast" />
            <property name="interval.amount" featurepath="/" featureProperty="minutesTimestep" />
        </kalypso.gmlProperty>

        <!-- Definition der Quellen, der DWD-Raster (Vorhersage) -->
        <!-- Scenario TEST -->
        <property name="szenario_TestDwdUrl1"
                  value="file:/${project.dir}/.model/dwd/lm_test1.txt" />
        <property name="szenario_TestDwdUrl2"
                  value="file:/${project.dir}/.model/dwd/lm_test2.txt" />
        <!-- Scenario Echt -->
        <property name="szenario_EchtDwdUrl1" value="file:/${project.dir}/.model/dwd/lm_test.txt" />
        <property name="szenario_EchtDwdUrl2" value="file:/${project.dir}/.model/dwd/lm_test.txt" />

        <property name="dwdRasterLocalPath" value="${calc.dir}/dwd/lm_aktuell.txt" />
        <property name="dwdRasterLocalURL" value="${calc.url}/dwd/lm_aktuell.txt" />


        <!-- Unterscheide zwischen Katastrophentest und normalem Szenario -->
        <kalypso.multiequals arg1="${scenarioId}" arg2="test">
            <!-- Links fürs Abholen der Vorhersage-Zeitreihen -->
            <property name="linkInOmbrometer" valueThen="NRepository1" valueElse="NRepository" />
            <property name="linkInObservation"
                      valueThen="in1ObservationLink"
                      valueElse="inObservationLink" />
            <property name="dwdRasterRemoteURLs"
                      valueThen="${szenario_TestDwdUrl1},${szenario_TestDwdUrl2}"
                      valueElse="${szenario_EchtDwdUrl1},${szenario_EchtDwdUrl2}" />
        </kalypso.multiequals>

        <kalypso.gmlProperty gmlURL="${calc.url}/.calculation">
            <property name="stopsim"
                      featurepath="/"
                      featureProperty="startforecast"
                      dateoffset="${hoursofforecast}"
                      dateoffsetfield="HOUR_OF_DAY" />
        </kalypso.gmlProperty>


        <property name="interval.field" value="MINUTE" />

        <echo message="interval.field:  ${interval.field}" />
        <echo message="interval.amount: ${interval.amount}" />

        <!-- define the requests -->
        <property name="requestN"
                  value="&lt;request xmlns=&quot;request.zml.kalypso.org&quot;&gt;&lt;axes&gt;date,N&lt;/axes&gt;&lt;statusAxes&gt;N&lt;/statusAxes&gt;&lt;/request&gt;" />
        <property name="requestQ"
                  value="&lt;request xmlns=&quot;request.zml.kalypso.org&quot;&gt;&lt;axes&gt;date,Q&lt;/axes&gt;&lt;statusAxes&gt;Q&lt;/statusAxes&gt;&lt;/request&gt;" />
        <property name="requestW"
                  value="&lt;request xmlns=&quot;request.zml.kalypso.org&quot;&gt;&lt;axes&gt;date,W&lt;/axes&gt;&lt;statusAxes&gt;W&lt;/statusAxes&gt;&lt;/request&gt;" />
        <property name="requestT"
                  value="&lt;request xmlns=&quot;request.zml.kalypso.org&quot;&gt;&lt;axes&gt;date,T&lt;/axes&gt;&lt;statusAxes&gt;T&lt;/statusAxes&gt;&lt;/request&gt;" />

        <!-- define the filters -->
        <!-- N: sum-filter -->
        <property name="filterN"
                  value="${requestN}&lt;filter&gt;&lt;intervallFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; mode=&quot;sum&quot; xmlns=&quot;filters.zml.kalypso.org&quot;/&gt;&lt;/filter&gt;" />
        <!-- Q/W: interpolation-filter -->
        <property name="filterW"
                  value="${requestW}&lt;filter&gt;&lt;interpolationFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; defaultStatus=&quot;2&quot; defaultValue=&quot;0.0&quot; forceFill=&quot;true&quot; xmlns=&quot;filters.zml.kalypso.org&quot;/&gt;&lt;/filter&gt;" />
        <property name="filterQ"
                  value="${requestQ}&lt;filter&gt;&lt;interpolationFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; defaultStatus=&quot;2&quot; defaultValue=&quot;0.0&quot; forceFill=&quot;true&quot; xmlns=&quot;filters.zml.kalypso.org&quot;/&gt;&lt;/filter&gt;" />
        <!-- T: intensity/average-filter -->
        <!-- Temperatur wird als Tageswert benötigt,
             der hydrologische Tag geht von 7 Uhr bis 7 Uhr, denn
			 manuelle Pegel werden um 7 Uhr morgens abgelesen -->
        <property name="intervalT.amount" value="1" />
        <property name="intervalT.field" value="HOUR_OF_DAY" />
        <!--
        <property name="intervalT.start.value" value="7" /> 
        <property name="intervalT.start.field" value="HOUR_OF_DAY" />
		-->
        <property name="filterT"
                  value="${requestT}&lt;filter&gt;&lt;intervallFilter amount=&quot;${intervalT.amount}&quot; calendarField=&quot;${intervalT.field}&quot; mode=&quot;intensity&quot;  defaultStatus=&quot;2&quot; defaultValue=&quot;5.0&quot;  xmlns=&quot;filters.zml.kalypso.org&quot;/&gt;&lt;/filter&gt;" />
        <!-- die Filter im Klartext: 

			filterN="?&lt;filter&gt;&lt;intervallFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; mode=&quot;sum&quot; xmlns=&quot;filters.zml.kalypso.org&quot;/&gt;&lt;/filter&gt;" 
			<filter>
				<intervallFilter amount="15" calendarField="MINUTE" mode="sum" xmlns="filters.zml.kalypso.org"/>
			</filter>" 
			
			filterQ="?&lt;filter&gt;&lt;intervallFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; mode=&quot;intensity&quot; xmlns=&quot;filters.zml.kalypso.org&quot;/&gt;&lt;/filter&gt;" />
			<filter>
				<interpolationFilter amount="1" calendarField="HOUR_OF_DAY" defaultStatus="2" defaultValue="0.0" forceFill="true" xmlns="filters.zml.kalypso.org"/>
			</filter>
		 -->

        <echo message=" # " />
        <echo message=" # - Parameter-Informationen -" />
        <echo message=" # " />
        <echo message=" # Szenario: '${scenarioId}'" />
        <echo message=" # " />
        <echo message=" # Link zum Abholden von Obrometern    : ${linkInOmbrometer}" />
        <echo message=" # Link zum Abholden anderer Zeitreihen: ${linkInObservation}" />
        <echo message=" # Quelle der verwendeten DWD-Raster-Vorhersagen: ${dwdRasterRemoteURLs}" />
        <echo message=" # " />
        <echo message=" # Zeiträume: " />
        <echo message=" # von                  : ${startsim}" />
        <echo message=" # vorhersage ab        : ${startforecast}" />
        <echo message=" # Zeitraum Vorhersage  : ${hoursofforecast} Stunden" />
        <echo message=" # bis                  : ${stopsim}" />
        <echo message=" # Berechnungsintervall : ${interval.amount} Minuten" />
        <echo message=" # " />
        <echo message=" # Filter Niederschlag : ${filterN}" />
        <echo message=" # " />
        <echo message=" # Filter Temperatur   : ${filterT}" />
        <echo message=" # " />
        <echo message=" # Filter Pegel        : ${filterW}" />
        <echo message=" # " />
        <echo message=" # Filter Zufluss      : ${filterQ}" />
        <echo message=" # " />
    </target>

    <target name="updateOmbrometer" depends="setProperties">
        <!-- updateOmbrometer(I,U):
						ombrometer von PSI-abholen						
	     -->
        <echo message="aktualisiere Ombrometer Zeitreihen im Rechenfall" />
        <kalypso.copyObservation gml="${calc.url}/ombrometer.gml"
                                 featurePath="ombrometerMember"
                                 context="${calc.url}"
                                 targetObservation="N"
                                 forecastFrom="${startforecast}"
                                 forecastTo="${stopsim}">
            <source property="${linkInOmbrometer}"
                    from="${startsim}"
                    to="${startforecast}"
                    filter="${filterN}" />
            <metadata name="Szenario" value="${scenarioId}" />
        </kalypso.copyObservation>
    </target>

    <target name="updateMeasuredN" depends="setProperties">
        <!-- updateMeassured(I,U):
						gebietsniederschlagsmodell in berechnet.zml einfügen
		 -->
        <echo message="aktualisiere Gebietsniederschläge (Messung)" />

        <kalypso.copyObservation gml="${project.url}/.model/kriging/mapping.gml"
                                 featurePath="mappingMember"
                                 context="${calc.url}"
                                 targetObservation="outObservationLink"
                                 forecastFrom="${startforecast}"
                                 forecastTo="${stopsim}">
            <source property="inObservationLink" from="${startsim}" to="${startforecast}" />
            <!-- Vorhersage übernehmen -->
            <source property="outObservationLink" from="${startforecast}" to="${stopsim}" />
            <metadata name="Szenario" value="${scenarioId}" />
        </kalypso.copyObservation>
    </target>

    <target name="fetchRaster" depends="setProperties">
        <!-- fetchRaster(I,U):	DWD-Raster-Vorhersage (Datei) in Rechenfall kopieren
		 -->
        <echo message="aktualisiere DWD-Raster im Rechenfall" />
        <Kalypso.fetchFromURL context="${calc.url}"
                              src="${dwdRasterRemoteURLs}"
                              listseparator=","
                              dest="${dwdRasterLocalPath}" />
    </target>

    <target name="updateForecastN" depends="setProperties">
        <!-- updateForecast(I,U):		
					  	Raster auslesen und in berechnet.zml einfügen
		 -->
        <echo message="aktualisiere Gebietsniederschläge (Vorhersage aus DWD-Raster ${dwdRasterLocalURL} )" />
        <kalypso.dwdTask dwd2zmlconfurl="${project.url}/.model/dwd/dwdZmlConfN.xml"
                         obsrasterurl="${dwdRasterLocalURL}"
                         targetcontext="${calc.dir}"
                         description="raster zu zml"
                         from="${startsim}"
                         forecastfrom="${startforecast}"
                         to="${stopsim}"
                         zmlfilter="${filterN}">
            <metadata name="Szenario" value="${scenarioId}" />
        </kalypso.dwdTask>
    </target>

    <target name="updateZuflussMessung" depends="setProperties">
        <echo message="aktualisiere Zufluesse (Messung)" />
        <kalypso.copyObservation gml="${project.url}/.model/observationConf/ZuflussMessungMapping.gml"
                                 featurePath="mappingMember"
                                 context="${calc.url}"
                                 targetObservation="outObservationLink"
                                 forecastFrom="${startforecast}"
                                 forecastTo="${stopsim}">
            <source property="${linkInObservation}"
                    from="${startsim}"
                    to="${startforecast}"
                    filter="${filterQ}" />
            <!-- Vorhersage übernehmen -->
            <source property="outObservationLink" from="${startforecast}" to="${stopsim}" />
            <metadata name="Szenario" value="${scenarioId}" />
        </kalypso.copyObservation>
    </target>

    <target name="updateZuflussVorhersage" depends="setProperties">
        <echo message="aktualisiere Zufluesse (Vorhersage)" />
        <kalypso.copyObservation gml="${project.url}/.model/observationConf/ZuflussVorhersageMapping.gml"
                                 featurePath="mappingMember"
                                 context="${calc.url}"
                                 targetObservation="outObservationLink"
                                 forecastFrom="${startforecast}"
                                 forecastTo="${stopsim}">
            <source property="outObservationLink" from="${startsim}" to="${startforecast}" />
            <source property="${linkInObservation}"
                    from="${startforecast}"
                    to="${stopsim}"
                    filter="${filterQ}" />
            <!-- Vorhersage übernehmen -->
            <metadata name="Szenario" value="${scenarioId}" />
        </kalypso.copyObservation>
    </target>

    <target name="updatePegelMessung" depends="setProperties">
        <echo message="aktualisiere Zufluesse (Messung)" />
        <kalypso.copyObservation gml="${project.url}/.model/observationConf/PegelMessungMapping.gml"
                                 featurePath="mappingMember"
                                 context="${calc.url}"
                                 targetObservation="outObservationLink"
                                 forecastFrom="${startforecast}"
                                 forecastTo="${stopsim}">
            <source property="${linkInObservation}"
                    from="${startsim}"
                    to="${startforecast}"
                    filter="${filterW}" />
            <!-- Vorhersage übernehmen -->
            <source property="outObservationLink" from="${startforecast}" to="${stopsim}" />
            <metadata name="Szenario" value="${scenarioId}" />
        </kalypso.copyObservation>
    </target>

    <target name="updateObsT" depends="setProperties">
        <echo message="aktualisiere Temperaturen (Messung)" />
        <kalypso.copyObservation gml="${project.url}/.model/observationConf/ObsTMapping.gml"
                                 featurePath="mappingMember"
                                 context="${calc.url}"
                                 targetObservation="outObservationLink"
                                 forecastFrom="${startforecast}"
                                 forecastTo="${stopsim}">
            <source property="${linkInObservation}"
                    from="${startsim}"
                    to="${startforecast}"
                    filter="${filterT}" />
            <!-- Vorhersage übernehmen -->
            <source property="outObservationLink" from="${startforecast}" to="${stopsim}" />
            <metadata name="Szenario" value="${scenarioId}" />
        </kalypso.copyObservation>
    </target>

    <target name="updateObsGebT" depends="setProperties">
        <echo message="rechen Temperaturen (Messung) auf gebiete um" />
        <kalypso.copyObservation gml="${project.url}/.model/observationConf/ObsTGebMapping.gml"
                                 featurePath="mappingMember"
                                 context="${calc.url}"
                                 targetObservation="outObservationLink"
                                 forecastFrom="${startforecast}"
                                 forecastTo="${stopsim}">
            <source property="inObservationLink" from="${startsim}" to="${startforecast}" />
            <!-- Vorhersage übernehmen -->
            <source property="outObservationLink" from="${startforecast}" to="${stopsim}" />
            <metadata name="Szenario" value="${scenarioId}" />
        </kalypso.copyObservation>
    </target>

    <target name="updateForecastT" depends="setProperties">
        <!-- updateForecast(I,U):		
    					  	Raster auslesen und in berechnet.zml einfügen
    		 -->
        <echo message="aktualisiere Gebietstemperaturen (Vorhersage aus DWD-Raster ${dwdRasterLocalURL} )" />
        <kalypso.dwdTask dwd2zmlconfurl="${project.url}/.model/dwd/dwdZmlConfT.xml"
                         obsrasterurl="${dwdRasterLocalURL}"
                         targetcontext="${calc.dir}"
                         description="raster zu zml"
                         from="${startsim}"
                         forecastfrom="${startforecast}"
                         to="${stopsim}"
                         zmlfilter="${filterT}">
            <metadata name="Szenario" value="${scenarioId}" />
        </kalypso.dwdTask>
    </target>

    <target name="updateAll"
            depends="fetchRaster,updateForecastN,updateOmbrometer,updateMeasuredN,updateZuflussMessung,updateZuflussVorhersage,updatePegelMessung,updateObsT,updateForecastT,updateObsGebT"
            description="Aktualisiert eine Rechenvariante">
        <echo message="aktualisiere alle Zeitreihen: ${calc.dir}" />
    </target>

    <target name="updateForecastNComplete"
            depends="fetchRaster,updateForecastN"
            description="Aktualisiert Vorhersage N von aktuellen DWD-Rasterdaten">
    </target>

    <target name="update" depends="updateAll" description="Aktualisiert eine Rechenvariante">
        <echo message="aktualisiere Zeitreihen: ${calc.dir}" />
    </target>
</project>