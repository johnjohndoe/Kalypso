<project default="fake">

	<!-- Zeitschritt der Berechnung: 1h-->
		<property name="interval.field" value="HOUR_OF_DAY"/>
		<property name="interval.amount" value="1"/>
	
    <!-- define the requests -->
	<property name="requestQ"
		value="&lt;request xmlns=&quot;request.zml.kalypso.org&quot;&gt;&lt;axes&gt;date,Q&lt;/axes&gt;&lt;statusAxes&gt;Q&lt;/statusAxes&gt;&lt;/request&gt;" />
	<property name="requestW"
		value="&lt;request xmlns=&quot;request.zml.kalypso.org&quot;&gt;&lt;axes&gt;date,W&lt;/axes&gt;&lt;statusAxes&gt;W&lt;/statusAxes&gt;&lt;/request&gt;" />
		
	<property name="requestPolder"
		value="&lt;request xmlns=&quot;request.zml.kalypso.org&quot;&gt;&lt;axes&gt;date,POLDER_CONTROL&lt;/axes&gt;&lt;statusAxes&gt;POLDER_CONTROL&lt;/statusAxes&gt;&lt;/request&gt;" />

	<!-- Vordefinierte Filter -->
    <!-- Q: interpolation-filter -->
	<property name="filterQ"
		value="${requestQ}&lt;filter&gt;&lt;interpolationFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; defaultStatus=&quot;2&quot; defaultValue=&quot;0.0&quot; forceFill=&quot;true&quot; xmlns=&quot;filters.zml.kalypso.org&quot; fillLastWithValid=&quot;true&quot; /&gt;&lt;/filter&gt;" />
	<property name="filterW"
		value="${requestW}&lt;filter&gt;&lt;interpolationFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; defaultStatus=&quot;2&quot; defaultValue=&quot;0.0&quot; forceFill=&quot;true&quot; xmlns=&quot;filters.zml.kalypso.org&quot; fillLastWithValid=&quot;true&quot; /&gt;&lt;/filter&gt;" />
	
    <property name="filterQOhneFortsetzung"
		value="${requestQ}&lt;filter&gt;&lt;interpolationFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; defaultStatus=&quot;2&quot; defaultValue=&quot;0.0&quot; forceFill=&quot;false&quot; xmlns=&quot;filters.zml.kalypso.org&quot; fillLastWithValid=&quot;false&quot; /&gt;&lt;/filter&gt;" />
	
	<!-- POLDER_CONTROL: ??? filter -->
	<property name="filterPolder"
		value="${requestPolder}&lt;filter&gt;&lt;interpolationFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; defaultStatus=&quot;2&quot; defaultValue=&quot;false&quot; forceFill=&quot;true&quot; xmlns=&quot;filters.zml.kalypso.org&quot; fillLastWithValid=&quot;true&quot; /&gt;&lt;/filter&gt;" />

 	
	<!-- Ablage W: mit Rundung auf +/- 5cm -->
	<property name="filterCommitPrognoseWDown" 
		value="&lt;filter&gt;&lt;roundFilter factor=&quot;5&quot; mode=&quot;ROUND_DOWN&quot; axisType=&quot;W&quot; xmlns=&quot;filters.zml.kalypso.org&quot;/&gt;&lt;/filter&gt;"/>
	<property name="filterCommitPrognoseWUp" 
		value="&lt;filter&gt;&lt;roundFilter factor=&quot;5&quot; mode=&quot;ROUND_UP&quot; axisType=&quot;W&quot; xmlns=&quot;filters.zml.kalypso.org&quot;/&gt;&lt;/filter&gt;"/>

	<!-- Ablage W, ohne Rundung (Filter für W und Q gleich?) -->
		<property name="filterCommitPrognoseW"
				value="&lt;filter&gt;&lt;interpolationFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; defaultStatus=&quot;4&quot; defaultValue=&quot;0.0&quot; forceFill=&quot;true&quot; xmlns=&quot;filters.zml.kalypso.org&quot; fillLastWithValid=&quot;true&quot; /&gt;&lt;/filter&gt;" />
		
	<!-- Ablage Q, ohne Rundung -->
	<property name="filterCommitPrognoseQ"
			value="&lt;filter&gt;&lt;interpolationFilter amount=&quot;${interval.amount}&quot; calendarField=&quot;${interval.field}&quot; defaultStatus=&quot;4&quot; defaultValue=&quot;0.0&quot; forceFill=&quot;true&quot; xmlns=&quot;filters.zml.kalypso.org&quot; fillLastWithValid=&quot;true&quot; /&gt;&lt;/filter&gt;" />
	
	<!-- - - - - - - - - - - - - - - - - - 
          target: fake                      nur damit das Projekt nicht schreit
         - - - - - - - - - - - - - - - - - -->
	<target name="fake" />

	<!-- 
		 ================================= 
          target: create			Rechenvariante erzeugen
         ================================= 
    -->
	<target name="create" description="Erzeugung der Rechenvariante">
			<echo message="Rechenvariante anlegen: ${calc.dir}" />

			<copy file="${project.dir}/modell.gml" tofile="${calc.dir}/calcCase.gml"/>
			<copy todir="${calc.dir}">
				<fileset dir="${project.dir}/.templates">
					<include name="*.gtt"/>
					<include name="*.gmt"/>
					<include name="*.gft"/>
					<include name="*.ott"/>
					<include name="*.odt"/>
					<include name="Zeitreihen/*.ott"/>
					<include name="Zeitreihen/*.odt"/>
					<include name="Ergebnisse/Zeitreihen/*.ott"/>
					<include name="Ergebnisse/Zeitreihen/*.odt"/>
					<include name="Ergebnisse/Zeitreihen_ohneVerschiebung/*.ott"/>
					<include name="Ergebnisse/Zeitreihen_ohneVerschiebung/*.odt"/>
				</fileset>
			</copy>
		</target>
	
	
    <!-- - - - - - - - - - - - - - - - - - 
          target: calculationProperties                      Initializes properties from .calculation
         - - - - - - - - - - - - - - - - - -->
    <target name="calculationProperties">
    	<property name="HOUR_OF_DAY" value="11"/>
    	<property name="DAY_OF_MONTH" value="5"/>

    	<!-- TRICK :-) Berechnen von startsim und stopsim in zweitem gmlpropertyTask, da dann die Ergebnisse des ersten auch zu Verfügung stehen...-->
		<kalypso.gmlProperty gmlURL="${calc.url}/.calculation">
			<property name="startforecast" featurepath="" featureProperty="startforecast"/>
			<property name="simulationDuration" featurepath="" featureProperty="simulationDuration"/>
			<property name="forecastDuration" featurepath="" featureProperty="forecastDuration"/>
			<property name="scenarioId" featurepath="" featureProperty="scenarioId" defaultValue=""/>
		</kalypso.gmlProperty>
    	
		<kalypso.gmlProperty gmlURL="${calc.url}/.calculation">
			<!-- startsim = Tagesanfang(startforecast - simulationDuration d) -->
			<property name="startsim" featurepath="" featureProperty="startforecast" dateoffset="-${simulationDuration}" dateoffsetfield="${DAY_OF_MONTH}" dateTruncField="${DAY_OF_MONTH}" />
			<!-- stopsim = startforecast + forecastDuration h -->
			<property name="stopsim" featurepath="" featureProperty="startforecast" dateoffset="${forecastDuration}" dateoffsetfield="${HOUR_OF_DAY}"/>
		</kalypso.gmlProperty>
    	
    	<echo message="Szenario der Rechenvariante ist: ${scenarioId}" />
    	
    	<!-- Unterscheide zwischen Katastrophentest und normalem Szenario -->
    			<kalypso.multiequals arg1="${scenarioId}" arg2="test">
    				<!-- Links fürs Abholen der Zeitreihen -->
    				<property name="pegelMessungLink" valueThen="in1ObservationLink" valueElse="inObservationLink"/>
    				<property name="pegelCzVorhersageLink" valueThen="in3ObservationLink" valueElse="in2ObservationLink"/>
    				<property name="zwischengebieteLink" valueThen="in1ObservationLink" valueElse="inObservationLink"/>
    				<property name="pegelMessungWInfoLink" valueThen="in3ObservationLink" valueElse="in2ObservationLink"/>
    				
    				<!-- Links für die Ablage der Vorhersage-Zeitreihen -->
    				<property name="vorhersageLinkNormal" valueThen="out5ObservationLink" valueElse="out2ObservationLink"/>
    				<property name="vorhersageLinkOben" valueThen="out4ObservationLink" valueElse="out1ObservationLink"/>
    				<property name="vorhersageLinkUnten" valueThen="out3ObservationLink" valueElse="outObservationLink"/>
    			</kalypso.multiequals>
    </target>
	
	<!-- 
		 ================================= 
          target: update			Zeitreihen aktualisieren & kombinieren...
         ================================= 
    -->
	<target name="update" depends="calculationProperties" description="Aktualisierung der Rechenvariante">
		<echo message="Zeitreihen aktualisieren: ${calc.dir}" />
		
		<copy todir="${calc.dir}/Zeitreihen">
			<fileset dir="${project.dir}/.templates/Zeitreihen">
				<include name="*.gmt"/>
				<include name="*.gtt"/>
				<include name="*.gft"/>
				<include name="*.ott"/>
				<include name="*.odt"/>
			</fileset>
		</copy>

		<!-- 
			Pegel
		-->
		<!-- Usti (W): Messung kombiniert mit tschechischen Vorhersagen -->
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/Usti.gml" featurePath="mappingMember" context="${calc.url}" targetObservation="outObservationLink" forecastFrom="${startforecast}" forecastTo="${stopsim}" description="Abholen der Messwerte und Kombination mit tschechischen Vorhersagen (Usti)">
			<source property="${pegelMessungLink}" from="${startsim}" to="${startforecast}" filter="${filterW}"/>
			<source property="${pegelCzVorhersageLink}" from="${startforecast}" to="${stopsim}" filter="${filterW}"/>
			<metadata name="Szenario" value="${scenarioId}"/>
		</kalypso.copyObservation>
		
		<!-- Elbepegel (W): nur Messung -->
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/Elbepegel.gml" featurePath="mappingMember" context="${calc.url}" targetObservation="outObservationLink" forecastFrom="${startforecast}" forecastTo="${stopsim}" description="Abholen der Messwerte der Elbepegel">
			<source property="${pegelMessungLink}" from="${startsim}" to="${startforecast}" filter="${filterW}"/>
			<metadata name="Szenario" value="${scenarioId}"/>
		</kalypso.copyObservation>

		<!-- Usti: zusätzlich "Messung" Q, zur Information -->
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/Usti_Cz_QMessung.gml" featurePath="mappingMember" context="${calc.url}" targetObservation="outObservationLink" forecastFrom="${startforecast}" forecastTo="${stopsim}" description="Abholen der Q-Messwerte für Usti (zur Information)">
			<source property="${pegelMessungWInfoLink}" from="${startsim}" to="${startforecast}" filter="${filterQ}"/>
			<metadata name="Szenario" value="${scenarioId}"/>
		</kalypso.copyObservation>
		
		<!-- 
			Zwischengebiete (Q)(Vergangenheit und Prognose aus einem PSI-Container) 
		-->
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/Zwischengebiete.gml" featurePath="mappingMember" context="${calc.url}" targetObservation="outObservationLink" forecastFrom="${startforecast}" forecastTo="${stopsim}" description="Abholen der Zwischengebietszuflüsse">
			<source property="${zwischengebieteLink}" from="${startsim}" to="${stopsim}" filter="${filterQ}"/>
			<metadata name="Szenario" value="${scenarioId}"/>
		</kalypso.copyObservation>
		<!-- 
			Löben (W) (wie Zwischengebiete - Vergangenheit und Prognose aus einem PSI-Container) 
		-->
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/Loeben.gml" featurePath="mappingMember" context="${calc.url}" targetObservation="outObservationLink" forecastFrom="${startforecast}" forecastTo="${stopsim}" description="Abholen der W-Zeitreihe für Löben">
			<source property="${zwischengebieteLink}" from="${startsim}" to="${stopsim}" filter="${filterW}"/>
			<metadata name="Szenario" value="${scenarioId}"/>
		</kalypso.copyObservation>
		
		<!-- 
			Polder (Zustand = POLDER_CONTROL)
		-->
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/Polder.gml" featurePath="mappingMember" context="${calc.url}" targetObservation="outObservationLink" forecastFrom="${startforecast}" forecastTo="${stopsim}" description="Abholen der Polder-Steuerung">
			<source property="${pegelMessungLink}" from="${startsim}" to="${stopsim}" filter="${filterPolder}"/>
			<metadata name="Szenario" value="${scenarioId}"/>
		</kalypso.copyObservation>
	</target>

	<!-- 
		 ================================= 
          target: runCalculation			
         ================================= 
    -->
	<target name="runCalculation" description="Durchführung der Simulationsrechnung">
		<echo message="Berechnung wird durchgeführt: ${calc.path}"/>
		<kalypso.runCalculation calccasefolder="${calc.path}" typeid="org.kalypso.model.wavos.elbe.sachsen.v1">
			<input id="CONTROL_GML" path=".calculation" relativeToCalcCase="true"/>
			<input id="GML" path="calcCase.gml" relativeToCalcCase="true"/>
			
			<input id="ZML_PEGEL" path="Zeitreihen/Pegel" relativeToCalcCase="true"/>
			<input id="ZML_POLDER" path="Zeitreihen/Polder" relativeToCalcCase="true"/>
			<input id="ZML_ZUFLUESSE" path="Zeitreihen/Zufluesse" relativeToCalcCase="true"/>
			
			<output id="LOG" path="Log-Dateien/elbeWavosSachsen.log" relativeToCalcCase="true"/>
			<output id="ERGEBNISSE" path="Ergebnisse" relativeToCalcCase="true"/>
			<output id="NATIVE_IN_DIR" path="Ergebnisse/.native/in" relativeToCalcCase="true"/>
			<output id="NATIVE_OUT_DIR"  path="Ergebnisse/.native/out" relativeToCalcCase="true"/>
			
			<clearAfterCalc path="Ergebnisse/Anfangswerte" relativeToCalcCase="true"/>
			<clearAfterCalc path="Ergebnisse/**/*.zml" relativeToCalcCase="true"/>
			<clearAfterCalc path="Log-Dateien" relativeToCalcCase="true" />
		</kalypso.runCalculation>
	</target>
	
    <!-- ================================= 
          target: exportVorhersagen              
         ================================= -->
    <target name="exportVorhersagen" depends="calculationProperties" description="Export der Prognosen nach PSICompact">
        <echo message="Vorhersagezeitreihen werden nach PSICompact geschrieben..."/>
   		<echo message="Szenario-ID der Rechenvariante ist: ${scenarioId}" />
   		<echo message="" />

       	<!-- Einmal normal und je einmal für die untere und die obere Umhüllende -->
       	
       	<!-- Die normale Umhüllende soll nicht mehr abgelegt werden
       	<echo message="Ablage der Rechenergebnisse"/>
       	<kalypso.commitPrognoses context="${calc.url}" featurepath="${exportPrognosenFeaturePath}" gml="${project.url}/.model/observationConf/VorhersageMapping.gml" localobs="local1" remoteobs="${vorhersageLinkNormal}" runasync="false" IgnoreIllegalFeaturePath="true"/>
       	-->
    	
    	<echo message="Ablage der Prognose für Usti Q"/>
    	<kalypso.commitPrognoses context="${calc.url}" featurepath="${exportPrognosenFeaturePath}" gml="${project.url}/.model/observationConf/VorhersageMappingQUsti.gml" sourcefilter="${filterCommitPrognoseQ}" localobs="local1" remoteobs="${vorhersageLinkNormal}" runasync="false" IgnoreIllegalFeaturePath="true"/>

    	<echo message="Ablage der Prognose für Usti W"/>
    	<kalypso.commitPrognoses context="${calc.url}" featurepath="${exportPrognosenFeaturePath}" gml="${project.url}/.model/observationConf/VorhersageMappingWUsti.gml" sourcefilter="${filterCommitPrognoseW}" localobs="local1" remoteobs="${vorhersageLinkNormal}" runasync="false" IgnoreIllegalFeaturePath="true"/>

       	<echo message="Ablage der oberen Umhüllenden Q"/>
       	<kalypso.commitPrognoses context="${calc.url}" featurepath="${exportPrognosenFeaturePath}" gml="${project.url}/.model/observationConf/VorhersageMappingQ.gml" sourcefilter="${filterCommitPrognoseQ}" localobs="local3" remoteobs="${vorhersageLinkOben}" runasync="false" IgnoreIllegalFeaturePath="true"/>
       	<echo message="Ablage der unteren Umhüllenden Q"/>
       	<kalypso.commitPrognoses context="${calc.url}" featurepath="${exportPrognosenFeaturePath}" gml="${project.url}/.model/observationConf/VorhersageMappingQ.gml" sourcefilter="${filterCommitPrognoseQ}" localobs="local2" remoteobs="${vorhersageLinkUnten}" runasync="false" IgnoreIllegalFeaturePath="true"/>

       	<echo message="Ablage der oberen Umhüllenden W"/>
       	<kalypso.commitPrognoses context="${calc.url}" featurepath="${exportPrognosenFeaturePath}" gml="${project.url}/.model/observationConf/VorhersageMappingW.gml" sourcefilter="${filterCommitPrognoseWUp}" localobs="local3" remoteobs="${vorhersageLinkOben}" runasync="false" IgnoreIllegalFeaturePath="true"/>
       	<echo message="Ablage der unteren Umhüllenden W"/>
       	<kalypso.commitPrognoses context="${calc.url}" featurepath="${exportPrognosenFeaturePath}" gml="${project.url}/.model/observationConf/VorhersageMappingW.gml" sourcefilter="${filterCommitPrognoseWDown}" localobs="local2" remoteobs="${vorhersageLinkUnten}" runasync="false" IgnoreIllegalFeaturePath="true"/>
</target>
</project>