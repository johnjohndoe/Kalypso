<?xml version="1.0" encoding="ISO-8859-1"?>

<project name="Kalypso-Sachsen: data" default="co-sachsen-models" basedir="..">

	<!-- Project full path -->
	<property name="project.path" value="${workspace}/KalypsoConfSachsen" />
	<property name="dist" value="${workspace}/KalypsoConfSachsen/deploy/server" />
	<property name="dist.data" value="${dist}/data" />
	<property name="dist.prognose" value="${dist.data}/mirrored/prognose" />

	<!-- begin server specific -->
	<property name="core.path" value="${workspace}/KalypsoCoreServices" />
	<property file="${core.path}/etc/ant/tomcat.properties" />
	<!-- end server specific -->
	
	<target name="prepare" description="Creates the build directory">
		<echo message="Creating the required directories...." />
		<mkdir dir="${dist}" />
		<mkdir dir="${dist.data}" />
		<mkdir dir="${dist.prognose}" />
	</target>

	<target name="clean" description="Removes the build directories">
		<delete dir="${dist.data}" />
		<delete file="${dist}/data.zip" />
	</target>

	<!-- copy data -->
	<target name="copy-data" depends="prepare" description="Copy the data files to the deploy dir" >
		<copy todir="${dist.data}">
			<fileset dir="${project.path}/deployable-data/data" excludes="**/CVS/**" />
		</copy>
	</target>

	<!-- checkout the Sachsen Models -->
	<target name="co-sachsen-models" depends="clean,copy-data">
		
		<antcall target="co-model">
			<param name="pPackage" value="KalypsoData/KalypsoSpree" />
			<param name="pName" value="Spree" />
		</antcall>
		
		<antcall target="co-model">
			<param name="pPackage" value="KalypsoData/KalypsoWeisseElster" />
			<param name="pName" value="WeisseElster" />
		</antcall>
		
	</target>
	
	<!-- Callable CVS checkout target 
		pPackage: the module to checkout
		pName: name of the Directory that will be created
	-->
	<target name="co-model" depends="prepare" >

		<pathconvert targetos="windows" property="copath" >
			<path path="${dist.prognose}/${pName}" />
	    </pathconvert>
		
		<exec executable="cmd.exe"
			dir="${project.path}/deployable-data" >
			<arg line="/C start ${project.path}/deployable-data/cvs-co.bat ${user.name} ${copath} ${pPackage}"/>
		</exec>
		
		<delete includeemptydirs="true">
			<!-- empty '.prognose' and 'Rechenvariante' dirs -->
		    <fileset dir="${dist.prognose}/${pName}/.prognose" includes="**/*"/>
		    <fileset dir="${dist.prognose}/${pName}/Rechenvarianten" includes="**/*"/>

			<!-- remove all '.calculation' files -->
			<fileset dir="${dist.prognose}/${pName}" includes="**/.calculation"/>

			<!-- remove all CVS files -->
			<fileset dir="${dist.prognose}/${pName}" defaultexcludes="false">
				<include name="**/CVS/*"/>
				<include name="**/CVS/**"/>
			</fileset>

		</delete>
	</target>
	
	<!-- copy data to the kalypso server -->
	<target name="deploy-bce" depends="co-sachsen-models" description="Copy the data files to the kalypso server" >
		<copy todir="\\\\${tomcat.server}\\kalypso$\\data" overwrite="true">
			<fileset dir="${dist.data}" includes="*/**" excludes="**/CVS/**" />
		</copy>
	</target>

</project>
