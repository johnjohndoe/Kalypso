<?xml version="1.0" encoding="UTF-8"?>
<section id="psicompact" vendor="sachsen">
  <title>Schnittstelle zu PSICompact</title>

  <indexterm>
    <primary>Schnittstellen</primary>

    <secondary>PSICompact</secondary>
  </indexterm>

  <para>Die Schnittstelle zwischen KALYPSO und PSICompact wird im Projekt
  <filename>KalypsoPSICompactAdapter</filename> implementiert, welches den
  Entwicklern den Zugriff auf das PSICompact-System ermöglicht: der Rechner
  muss der PSICompact-Umgebung bekannt sein (<emphasis>Im Leitstand
  aufgenommen</emphasis>). Der Zugriff ist lediglich innerhalb des Intranets
  möglich, ein Fernzugriff über Internet ist nicht möglich.</para>

  <section>
    <title>Überblick</title>

    <indexterm>
      <primary>Schnittstellen</primary>

      <secondary>PSICompact</secondary>

      <tertiary>Überblick</tertiary>
    </indexterm>

    <para>Die Schnittstelle wird in drei Bereichen von KALYPSO benutzt:</para>

    <informaltable>
      <tgroup cols="3">
        <colspec align="left" colwidth="9*" />

        <colspec align="left" colwidth="5*" />

        <colspec align="left" colwidth="6*" />

        <thead>
          <row>
            <entry align="center">PSICompact (Methode)</entry>

            <entry align="center">Einsatz in KALYPSO</entry>

            <entry align="center">Beschreibung</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry><methodname>getInfo</methodname>,
            <methodname>getArchiveData</methodname>,
            <methodname>setArchiveData</methodname>,
            <methodname>getWQParams</methodname>,
            <methodname>getObjectMetaData</methodname>,
            <methodname>getMeasureType</methodname></entry>

            <entry>Zeitreihen</entry>

            <entry>Zeitreihen inkl. Metadaten abfragen. Daten zurückschreiben
            (Vorhersage-Zeitreihe)</entry>
          </row>

          <row>
            <entry><methodname>getUserClasses</methodname>,
            <methodname>getUserRights</methodname>,
            <methodname>getUser</methodname></entry>

            <entry>Benutzerrechte</entry>

            <entry>Benutzerrechte abfragen</entry>
          </row>

          <row>
            <entry><methodname>copyanddistributeFile</methodname></entry>

            <entry>Dokumentenablage</entry>

            <entry>Dateiverteilung</entry>
          </row>
        </tbody>
      </tgroup>
    </informaltable>
  </section>

  <section id="sst_psicompact_code">
    <title>Quellcode</title>

    <indexterm>
      <primary>Schnittstellen</primary>

      <secondary>PSICompact</secondary>

      <tertiary>Quellcode</tertiary>
    </indexterm>

    <para>Die Implementierung in KALYPSO basiert auf dem IRepository-Framework
    (siehe Java-Interface
    <filename>org.kalypso.repository.IRepository</filename>). Die
    Schnittstelle wird nur serverseitig benutzt. Die Server müssen wie oben
    beschrieben in der PSICompact-Umgebung integriert sein, sonst ist kein
    Zugriff möglich.</para>

    <para>PSI hat das Java-Interface <filename>PSICompact.java</filename>
    (siehe <filename>de.psi.go.lhwz.PSICompact</filename>) zur Verfügung
    gestellt. Um die Schnittstellenimplementation ohne laufende Datenbank
    testen zu können, wurde eine Pseudo-Implementation der Schnittstelle in
    Form der Klasse
    <filename>org.kalypso.psiadapter.PSICompactFakeImpl</filename> geschaffen.
    Durch setzen der System-Property
    <filename>kalypso.psifake.location</filename> auf ein Datenverzeichnis
    wird diese Pseudo- Implementation aktiviert. Das gesetzte Datenverzeichnis
    muss die Struktur und Daten der simulierten Datenbank in Form von
    ZML-Dateien enthalten. Ist die System-Property nicht gesetzt, wird die
    richtige Implementation der Schnittstelle aktiviert.</para>

    <para>In der Datei
    <filename>org/kalypso/psiadapter/resources/config.ini</filename> sind eine
    Reihe von Einstellungen der Schnittstelle konfigurierbar, welche direkt in
    der Konfigurationsdatei beschrieben sind.</para>
  </section>

  <section>
    <title>Laufzeit</title>

    <indexterm>
      <primary>Schnittstellen</primary>

      <secondary>PSICompact</secondary>

      <tertiary>Laufzeit</tertiary>
    </indexterm>

    <para>Zur Laufzeit werden folgende Bibliotheken benötigt:</para>

    <itemizedlist>
      <listitem>
        <para><filename>PSICompact.jar</filename></para>
      </listitem>

      <listitem>
        <para><filename>OB.jar</filename></para>
      </listitem>
    </itemizedlist>

    <para>Diese Jars sind im Projekt
    <filename>KalypsoAdapterPSICompact</filename> abgelegt. Da Tomcat im
    Sicherheitsmodus gestartet wird, sind entsprechende Einträge für die
    PSICompact-Codebase notwendig. Die Datei
    <filename>catalina.policy</filename> beinhaltet einen speziellen Bereich
    für PSICompact (siehe <filename>catalina.policy</filename> im
    <filename>conf</filename>-Verzeichnis von Tomcat).</para>
    
    <para>Die Schnittstelle wird zur Laufzeit in regelmässigen Abständen verworfen, um den Neustart
    des KALYPSO-Servers bei Neustart der PSI-Laufzeitumgebung zu vermeiden. Das Intervall der
    Neuinitialisierung wird durch Setzen der System-Property <filename>kalypso.psi.reinit</filename> 
    (in Millisekunden) definiert.</para>
  </section>

  <section>
    <title>Zeitreihen</title>

    <indexterm>
      <primary>Schnittstellen</primary>

      <secondary>PSICompact</secondary>

      <tertiary>Zeitreihen</tertiary>
    </indexterm>

    <para>Prinzipiell können alle in PSICompact konfigurierten Stationen über
    ihre jeweiligen Archivtypen abgerufen werden.</para>

    <para>Beim Zurückschreiben wird zuerst der Zeitreihencontainer mit dem
    Wert -1 beschrieben, um eventuell vorhandene Werte zu löschen. Dies
    geschieht in der vollen Auflösung für den zu schreibenden Zeitraum,
    erweitert um die in den Variablen OVERWRITE_AMOUNT_BEFORE und
    OVERWRITE_AMOUNT_AFTER angegebenen Werte.</para>

    <para>Danach wird der eigentlich zu schreibende Zeitraum in der
    vorliegenden Auflösung geschrieben. Eine eventuelle Anpassunge der zu
    schreibenden Werte (z.B. Rundung oder Änderung der Schrittweite) erfolgt
    durch Angabe von Filterausdrücken in den Ablageskripten.</para>

    <para>Dieses Vorgehen stellt die richtige Darstellung im Internet sicher
    (siehe <xref linkend="fig_overwrite_psicompact" />)). <figure
        id="fig_overwrite_psicompact">
        <title>Überschreibung der Werte</title>

        <mediaobject>
          <imageobject>
            <imagedata fileref="img/sst/sachsen/overwrite-psicompact.png"
                       scale="75" />
          </imageobject>
        </mediaobject>
      </figure></para>

    <para>Wie die Werte überschrieben werden, kann anhand der folgenden
    Eigenschaften aus der Konfigurationsdatei (siehe <xref
    linkend="sst_psicompact_code" />) des KalypsoAdapterPSICompact frei
    definiert werden: <glosslist>
        <glossentry>
          <glossterm>OVERWRITE_CALENDAR_FIELD</glossterm>

          <glossdef>
            <para>das Kalender-Feld im Sinne von
            <filename>java.util.Calendar</filename>, worauf AMOUNT_BEFORE und
            AMOUNT_AFTER sich beziehen</para>
          </glossdef>
        </glossentry>

        <glossentry>
          <glossterm>OVERWRITE_AMOUNT_BEFORE</glossterm>

          <glossdef>
            <para>Anzahl der Zeit-Einheiten, die vor dem Beginn einer
            Zeitreihe überschrieben werden, bevor die Zeitreihe nach
            PSICompact zurückgeschrieben wird</para>
          </glossdef>
        </glossentry>

        <glossentry>
          <glossterm>OVERWRITE_AMOUNT_AFTER</glossterm>

          <glossdef>
            <para>Anzahl der Zeit-Einheiten, die nach dem Ende einer Zeitreihe
            überschrieben werden, bevor die Zeitreihe nach PSICompact
            zurückgeschrieben wird</para>
          </glossdef>
        </glossentry>
      </glosslist>PSICompact liefert definierte Statuswerte zu den Werten
    einer Zeitreihe. Diese müssen auf die innerhalb von KALYPSO benutzten
    Stati abgebildet werden. Die Umwandlung der Status-Information erfolgt
    beim Abruf der Daten aus PSICompact in folgender Weise (siehe <xref
    linkend="tbl_psiStati" />):</para>

    <table id="tbl_psiStati">
      <title>Status-Tabelle</title>

      <tgroup align="left" cols="5" colsep="1" rowsep="1">
        <colspec colname="c1" colwidth="3*" />

        <colspec colname="c2" colwidth="5*" />

        <colspec colname="c3" colwidth="1*" />

        <colspec colname="c4" colwidth="1*" />

        <colspec colname="c5" colwidth="1*" />

        <thead>
          <row>
            <entry align="center" nameend="c2" namest="c1">PSICompact</entry>

            <entry align="center" nameend="c5"
            namest="c3">KALYPSO-Status</entry>
          </row>

          <row>
            <entry align="center" nameend="c2" namest="c1"></entry>

            <entry><emphasis>OK</emphasis></entry>

            <entry><emphasis>Wert auf Gültigkeit prüfen</emphasis></entry>

            <entry><emphasis>Vom Benutzer geändert</emphasis></entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>STATUS_AUTO</entry>

            <entry>Der Archivwert wurde durch eine automatische Nachberechnung
            gebildet. Der Wert kann für die Prognose verwendet werden</entry>

            <entry align="center">X</entry>

            <entry></entry>

            <entry></entry>
          </row>

          <row>
            <entry>STATUS_ERSALLG</entry>

            <entry>Mindestens ein Ersatzwert ist in die automatische
            Wertbildung eingeflossen, d.h. der Wert ist für die Prognose u.U.
            nicht verwendbar</entry>

            <entry></entry>

            <entry align="center">X</entry>

            <entry></entry>
          </row>

          <row>
            <entry>STATUS_MANKOR</entry>

            <entry>Der Archivwert ist manuell korrigiert worden, d.h. das
            Ergebnis der automatischen Verdichtung ist überschrieben worden.
            Der Wert kann für die Prognose verwendet werden</entry>

            <entry></entry>

            <entry></entry>

            <entry align="center">X</entry>
          </row>

          <row>
            <entry>STATUS_NACH</entry>

            <entry>Der Archivwert wurde automatisch nachgeführt. Die
            automatische Nachführung sorgt beim Start des Archivdienstes
            automatisch dafür, dass nicht vorhandene Archivwerte erzeugt
            werden. Wie die Archivwerte erzeugt werden, richtet sich nach der
            parametrierten Nachführstrategie dieses Objektes. Der Wert kann
            für die Prognose u.U. nicht verwendet werden</entry>

            <entry></entry>

            <entry align="center">X</entry>

            <entry></entry>
          </row>

          <row>
            <entry>STATUS_NORM</entry>

            <entry>Ein Archivwert wird als normiert bezeichnet, wenn er nicht
            existiert, d.h. nicht oder noch nicht geschrieben wurde. Der Wert
            kann für die Prognose nicht verwendet werden</entry>

            <entry></entry>

            <entry align="center">X</entry>

            <entry></entry>
          </row>

          <row>
            <entry>STATUS_NORMALLG</entry>

            <entry>Mindestens ein normierter Archivwert ist in die Wertbildung
            während der Verdichtung eingeflossen. Der Wert kann für die
            Prognose u.U. nicht verwendet werden</entry>

            <entry></entry>

            <entry align="center">X</entry>

            <entry></entry>
          </row>

          <row>
            <entry>STATUS_OK</entry>

            <entry>Status OK</entry>

            <entry align="center">X</entry>

            <entry></entry>

            <entry></entry>
          </row>

          <row>
            <entry>STATUS_UNDEF</entry>

            <entry>Status nicht definiert</entry>

            <entry></entry>

            <entry align="center">X</entry>

            <entry></entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <para>Wenn Prognose-Zeitreihen von KALYPSO nach PSICompact
    zurückgeschrieben werden, bekommen sie automatisch den Status
    PSICompact.STATUS_REKO.</para>

    <para>Neben den eigentlichen Werten liefert die PSICompact-Schnittstelle
    eine Reihe weiterer Informationen über die Zeitreihe bzw. über Ihre
    Station, welche in Form von Metadaten in der KALYPSO-Zeitreihe abgelegt
    werden (siehe <xref linkend="tbl_psiMetadata" />).</para>

    <table id="tbl_psiMetadata">
      <title>Metadaten</title>

      <tgroup cols="3" colsep="1" rowsep="1">
        <colspec align="left" colname="c1" colnum="" />

        <colspec align="left" colname="c2" colwidth="1*" />

        <colspec align="left" colname="c3" colwidth="1*" />

        <thead>
          <row>
            <entry align="center">Metadatum</entry>

            <entry align="center">Wert</entry>

            <entry align="center">Entstehung</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry>Name</entry>

            <entry>Bezeichnung des PSI-Containers</entry>

            <entry>PSI-Adapter</entry>
          </row>

          <row>
            <entry>Beschreibung</entry>

            <entry>Beschreibung der Spur</entry>

            <entry>Object-Info aus PSICompact</entry>
          </row>

          <row>
            <entry>Entstehung</entry>

            <entry>Immer 'PSICompact'</entry>

            <entry>PSI-Adapter</entry>
          </row>

          <row>
            <entry>Rechtswert</entry>

            <entry>Lage der Station</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Hochwert</entry>

            <entry>Lage der Station</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Koordinatensystem</entry>

            <entry>EPSG-Code für Rechtswert-Hochwert als</entry>

            <entry>PSI-Adapter</entry>
          </row>

          <row>
            <entry>Höhenangabeart</entry>

            <entry>NN oder HN</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Pegelnullpunkt</entry>

            <entry>Pegelnullpunkt</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Messtischblattnummer</entry>

            <entry>Messtischblattnummer</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Alarmstufe 1</entry>

            <entry>Alarmstufe 1</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Alarmstufe 2</entry>

            <entry>Alarmstufe 2</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Alarmstufe 3</entry>

            <entry>Alarmstufe 3</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Alarmstufe 4</entry>

            <entry>Alarmstufe 4</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Einheit in PSI-Compact</entry>

            <entry>Einheit der Werte in PSICompact</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Archivtyp</entry>

            <entry>Abgerufenes Archiv (MIN15, ...)</entry>

            <entry>Abgefragter Wert (Request)</entry>
          </row>

          <row>
            <entry>vorhandene Archivetypen</entry>

            <entry>Für diese Spur vorhandene Archivtypen</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Gewässer</entry>

            <entry>Gewässer</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>Flussgebiet</entry>

            <entry>Flussgebiet</entry>

            <entry>Metadata aus PSICompact</entry>
          </row>

          <row>
            <entry>WQ-Parameter</entry>

            <entry>W/Q-Beziehung in Form von Wechmann Parametern</entry>

            <entry>PSICompact (siehe Unten)</entry>
          </row>

          <row>
            <entry>WQ-Tabelle</entry>

            <entry>W/Q-Beziehung in From einer W/Q-Tabelle</entry>

            <entry>Kalypso Server (siehe Unten)</entry>
          </row>
        </tbody>
      </tgroup>
    </table>

    <section>
      <title>W/Q-Beziehung</title>

      <para>Die W/Q-Beziehung wird für Zeitreihen, welche über die
      PSI-Schnittstelle abgerufen werden, als Metadatum an die ZML-Datei
      geschrieben. Es gibt hierbei zwei Möglichkeiten:</para>

      <variablelist>
        <varlistentry>
          <term>Wechmann Parameter</term>

          <listitem>
            <para>Ohne weitere Angabe wird versucht, die W/Q-Beziehung in Form
            von Wechmann-Parametern über die PSICompact-Schnittstelle zu
            beziehen. Liegt in PSICompact keine W/Q-Beziehung vor, bleibt das
            Feld leer, eine Umrechnung ist dann seitens Kalypso nicht
            möglich.</para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term>AbflussTafel</term>

          <listitem>
            <para>Alternativ kann auf dem Kalypso-Server über die
            Konfigurationsdatei
            \\lfug-kv-01\d\Programme\kalypso\Tomcat5.0\webapps\webdav\at_data\at.ini
            für jede Spur eine zusätzliche AbflussTafel im .at-Format
            definiert werden. Ist dies für eine Spur der Fall, erscheint im
            Zeitreihen-Repository ein zusätzlicher Knoten 'at', über den die
            gleiche Zeitreihe bezogen wird. Statt der in PSICompact
            vorliegenden W/Q-Beziehung wird in diesem Fall aber die definierte
            AbflussTafel übergeben. Die Umrechnung in Kalypso erfolgt über
            diese AbflussTafel. Für Spuren mit mehreren Archivtypen (Min15,
            Hour) gilt die AbflussTafel gleichzeitig für alle Archivtypen (im
            Zeitreihenbrowser erhält jede Archivspur eine Unterspur 'at').
            </para>

            <para>Soll ein Modell auf AT-Zeitreihen zugreifen, muss für den
            Zeitreihenabruf die entsprechende at-Spur konfiguriert werden. Der
            Link auf diese Spur kann über den Zeitreihenbrowser ermittelt
            werden.</para>
          </listitem>
        </varlistentry>
      </variablelist>
    </section>
  </section>

  <section>
    <title>Benutzerrechte</title>

    <indexterm>
      <primary>Schnittstellen</primary>

      <secondary>PSICompact</secondary>

      <tertiary>Benutzerrechte</tertiary>
    </indexterm>

    <para>Es werden nur die Benutzerklassen eines Benutzers abgerufen. KALYPSO
    unterstützt folgende Zeichenketten von Benutzerklassen (siehe
    org.kalypso.services.user.UserServiceConstants.java):</para>

    <itemizedlist>
      <listitem>
        <para><emphasis>Vorhersage</emphasis></para>
      </listitem>

      <listitem>
        <para><emphasis>Experte</emphasis></para>
      </listitem>

      <listitem>
        <para><emphasis>Administration</emphasis></para>
      </listitem>
    </itemizedlist>

    <para>Weitere feingranulierte Benutzerrechte werden nicht benötigt. Die
    Client-Anwendung passt die Oberfläche automatisch an die Benutzerklassen
    eines Benutzers an.</para>

    <para>Die Konfiguration des <classname>KalypsoUserService</classname>
    bestimmt, welche Klasse aus dem
    <classname>KalypsoPSICompactAdapter</classname>-Projekt die
    Implementierung übernimmt: <programlisting>PROVIDER=org.kalypso.psiadapter.users.PSICompactRightsProvider</programlisting></para>
  </section>

  <section>
    <title>Dokumentablage</title>

    <indexterm>
      <primary>Schnittstellen</primary>

      <secondary>PSICompact</secondary>

      <tertiary>Dokumentablage</tertiary>
    </indexterm>

    <para>Dokumente werden durch eine XML-Metadata-Datei ergänzt und in das
    Verteilungsverzeichnis von PSICompact kopiert. Der Aufbau dieser XML-Datei
    ist von PSI vorgegeben. Es gibt dazu ein Schema im xdr-Format (siehe
    Anlage anlage_sst_LHWZDokRepImport.xdr).</para>

    <para>Die Konfiguration des <classname>KalypsoMetaDocService</classname>
    beinhaltet relevante Einstellungen zu PSICompact. Mehr Details dazu finden
    Sie in der Konfigurationsdatei des Dienstes.</para>
  </section>

  <section>
    <title>Weitere Information</title>

    <indexterm>
      <primary>Schnittstellen</primary>

      <secondary>PSICompact</secondary>

      <tertiary>weitere Information</tertiary>
    </indexterm>

    <informaltable>
      <tgroup cols="2">
        <colspec align="left" colwidth="1*" />

        <colspec align="left" colwidth="2*" />

        <thead>
          <row>
            <entry align="center">Dokument</entry>

            <entry align="center">Anlage</entry>
          </row>
        </thead>

        <tbody>
          <row>
            <entry><classname>PSICompact.java</classname></entry>

            <entry>anlage_sst_PSICompact.java</entry>
          </row>

          <row>
            <entry>Schnittstellenbeschreibung v1.08 von PSI</entry>

            <entry>anlage_sst_SchnittstellenbeschreibungLos2_0108.doc</entry>
          </row>

          <row>
            <entry>Telefonvermerke zum Thema Schnittstelle mit PSI vom
            25.05.2004 und 04.06.2004</entry>

            <entry>anlage_sst_20040525_fon_Schnittstelle mit PSI.doc
            anlage_sst_20040604_fon_Schnittstelle mit PSI v1.06.doc</entry>
          </row>

          <row>
            <entry>Dokument zum Ist-Zustand und der Bedarfsanalyse der
            Schnittstelle von PSI</entry>

            <entry>anlage_sst_Analyse Schnittstelle PSI_V2.doc</entry>
          </row>

          <row>
            <entry>Protokoll der Installation der KALYPSO-Server vom
            29.10.2004</entry>

            <entry>anlage_sst_20041029_Protokoll_Kalypso_Server.doc</entry>
          </row>
        </tbody>
      </tgroup>
    </informaltable>
  </section>
</section>