<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="KalypsoConfLocalhost: services" default="redeploy-services" basedir=".">
<!-- 
files and properties to check whith new configuration: 
properties:
 project.path
files:
 kalypso-init
 deploy.properties
-->
  
  
	<property name="project.path" value="${workspace}/KalypsoConfLocalhost" />
	<property name="dep.server" value="${project.path}/deploy/server" />
	<property name="dep.services" value="${dep.server}/services" />

	<target name="prepare">
		<echo message="Creating the required directories...." />
		<mkdir dir="${dep.server}" />
		<mkdir dir="${dep.services}" />
	</target>

	<target name="clean">
		<echo message="Cleaning all subprojects..." />
		<delete dir="${dep.services}" />
		<ant antfile="${workspace}/KalypsoUtil/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoRepository/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoDeegree/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoCore/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoCoreServices/etc/ant/project-build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoCalcService/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoMetaDocService/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoObsService/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoUserService/etc/ant/build.xml" target="clean" inheritAll="false" />
<!--
		<ant antfile="${workspace}/KalypsoSpreePlugin/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/Kalypso2d/etc/ant/build.xml" target="clean" inheritAll="false" />
-->
		<ant antfile="${workspace}/KalypsoDWD/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoOptimizePlugin/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoNA/etc/ant/build.xml" target="clean" inheritAll="false" />

		<ant antfile="${workspace}/KalypsoPSICompactAdapter/etc/ant/build.xml" target="clean" inheritall="false" />
		<ant antfile="${workspace}/KalypsoPSICompactImpl/build.xml" target="clean" inheritall="false" />
	</target>

	<target name="build-basic" depends="prepare">
		<echo message="Building basic projects" />
		<ant antfile="${workspace}/KalypsoUtil/etc/ant/build.xml" target="deploy" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoRepository/etc/ant/build.xml" target="deploy" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoDeegree/etc/ant/build.xml" target="deploy" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoCore/etc/ant/build.xml" target="deploy" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoCoreServices/etc/ant/project-build.xml" target="deploy" inheritAll="false" />
	</target>

	<target name="build-plugins" depends="build-basic, build-CalcService">
		<echo message="Building specific plugins for Sachsen" />
<!--
		<ant antfile="${workspace}/KalypsoSpreePlugin/etc/ant/build.xml" target="deploy" inheritAll="false" />
		<ant antfile="${workspace}/Kalypso2d/etc/ant/build.xml" target="deploy" inheritAll="false" />
-->	
		<ant antfile="${workspace}/KalypsoDWD/etc/ant/build.xml" target="deploy" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoOptimizePlugin/etc/ant/build.xml" target="deploy" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoNA/etc/ant/build.xml" target="deploy" inheritAll="false" />
	</target>

	<target name="modelplugins-dependency" depends="build-plugins">
		<echo message="Copying the libs relevant for using Spree-Plugin and NA-Plugin"/>
		
	<!--
		<copy todir="${workspace}/KalypsoCalcService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/KalypsoSpreePlugin/build/deploy" includes="**/*.jar" />
		</copy>

		<copy todir="${workspace}/KalypsoCalcService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/Kalypso2d/build/deploy" includes="**/*.jar" />
		</copy>
	-->
		<copy todir="${workspace}/KalypsoCalcService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/KalypsoOptimizePlugin/build/deploy" includes="**/*.jar" />
		</copy>

		<copy todir="${workspace}/KalypsoCalcService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/KalypsoNA/build/deploy" includes="**/*.jar" />
		</copy>
		
	</target>

	<target name="psicompact-fake" depends="prepare, build-basic">
		<echo message="Integrating the fake implementation of PSICompact"/>
		<delete file="${workspace}/KalypsoPSICompactAdapter/lib/PSICompact.jar" />
		<ant antfile="${workspace}/KalypsoPSICompactImpl/build.xml" target="deploy" inheritall="false" />
		<ant antfile="${workspace}/KalypsoPSICompactAdapter/etc/ant/build.xml" target="deploy" inheritall="false" />
	</target>

	<target name="psicompact-echte" depends="prepare, build-basic">
		<echo message="Integrating the real implementation of PSICompact"/>
		<copy file="${project.path}/deployable-services/echte-psicompact/PSICompact.jar" tofile="${workspace}/KalypsoPSICompactAdapter/lib/PSICompact.jar" overwrite="true" />
		<ant antfile="${workspace}/KalypsoPSICompactAdapter/etc/ant/build.xml" target="deploy" inheritall="false" />
	</target>

	<target name="build-ConfService">
		<ant antfile="KalypsoConf/etc/ant/build.xml" target="build-war">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="build-UserService" depends="build-basic">
		<ant antfile="${workspace}/KalypsoUserService/etc/ant/build.xml" target="build" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<copy todir="${workspace}/KalypsoUserService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/KalypsoPSICompactAdapter/build/deploy" includes="**/*.jar" />
		</copy>
	</target>

	<target name="build-ObsService" depends="build-basic">
		<ant antfile="${workspace}/KalypsoObsService/etc/ant/build.xml" target="build" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<copy todir="${workspace}/KalypsoObsService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/KalypsoPSICompactAdapter/build/deploy" includes="**/*.jar" />
		</copy>
	</target>

	<target name="build-CalcService" depends="build-basic">
		<ant antfile="${workspace}/KalypsoCalcService/etc/ant/build.xml" target="build" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="build-MetaDocService" depends="build-basic">
		<ant antfile="${workspace}/KalypsoMetaDocService/etc/ant/build.xml" target="build" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<copy todir="${workspace}/KalypsoMetaDocService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/KalypsoPSICompactAdapter/build/deploy" includes="**/*.jar" />
		</copy>
	</target>

	<target name="build-services-dev" depends="psicompact-fake,build-ConfService,build-CalcService,build-MetaDocService,build-ObsService,build-UserService,build-plugins,modelplugins-dependency">
		<echo message="Building all services" />
	</target>
	
	<target name="deploy-services" depends="build-services-dev" >
		<echo message="Deploying all services on the server named ${tomcat.server}" />

		<ant antfile="${workspace}/KalypsoCalcService/etc/ant/build.xml" target="deploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<ant antfile="${workspace}/KalypsoMetaDocService/etc/ant/build.xml" target="deploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<ant antfile="${workspace}/KalypsoObsService/etc/ant/build.xml" target="deploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<ant antfile="${workspace}/KalypsoUserService/etc/ant/build.xml" target="deploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<ant antfile="KalypsoConf/etc/ant/build.xml" target="deploy">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="redeploy-UserService" depends="psicompact-fake,build-UserService">
		<echo message="Redeploying User Service" />
		<ant antfile="${workspace}/KalypsoUserService/etc/ant/build.xml" target="redeploy-all" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="redeploy-ObsService" depends="psicompact-fake,build-ObsService">
		<echo message="Redeploying Observation Service" />
		<ant antfile="${workspace}/KalypsoObsService/etc/ant/build.xml" target="redeploy-all" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="redeploy-MetaDocService" depends="psicompact-fake,build-MetaDocService">
		<echo message="Redeploying MetaDoc Service" />
		<ant antfile="${workspace}/KalypsoMetaDocService/etc/ant/build.xml" target="redeploy-all" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="redeploy-CalcService" depends="psicompact-fake,build-CalcService,modelplugins-dependency">
		<echo message="Redeploying Calculation Service" />
		<ant antfile="${workspace}/KalypsoCalcService/etc/ant/build.xml" target="redeploy-all" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="redeploy-ConfService" depends="prepare,build-ConfService">
		<echo message="Redeploying Configuration Service" />
		<ant antfile="KalypsoConf/etc/ant/build.xml" target="redeploy">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="redeploy-services" depends="redeploy-ConfService,redeploy-UserService,redeploy-ObsService,redeploy-CalcService,redeploy-MetaDocService" >
		<echo message="Redeploying all services" />
	</target>

</project>
