<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="Kalypso-SachsenAnahlt: kunden-server" default="deploy-lhz" basedir=".">

    <!-- 
		Description: central build file for the SachsenAnhalt Project.
		
		Targets which have a description element are so-called public-targets,
		that is, targets that you (the deployer) are more likely to use
		to deploy the files. Public targets appear with a dark green circle
		in the ant-outline and the ant-view (other targets are light green).
		
		The default target is the deploy target to use when deploying for
		the LHZ.
		
		______________________________________________________________________
		Checklist:
		
		: Server-Deploy fpr BCE :
		See build.xml file in parallel folder 'deployable-server-bce'
		
		: Server-Deploy for LHZ :
		1. deploy-lhz
		
	-->

    <property name="project.path" value="${workspace}/KalypsoConfSachsenAnhalt" />
    <property name="src.path" value="${project.path}/deployable-server-kunde/webdav" />

    <property name="dist" value="${project.path}/deploy/server" />
    <property name="dist.webdav" value="${dist}/webdav" />

    <target name="prepare">
        <echo message="Creating the required directories...." />
        <mkdir dir="${dist}" />
        <mkdir dir="${dist.webdav}" />
        <mkdir dir="${dist.webdav}/prognose" />
    </target>

    <target name="clean">
        <echo message="Cleaning all subprojects..." />
        <delete dir="${dist}" />
        <ant antfile="${workspace}/KalypsoBuild/central-build/build-core.xml" target="clean" inheritAll="false" />
        <ant antfile="${workspace}/KalypsoAdapterWiski/etc/ant/build.xml" target="clean" inheritAll="false" />
        <ant antfile="${workspace}/KalypsoServiceCalc/etc/ant/build.xml" target="clean" inheritAll="false" />
        <ant antfile="${workspace}/KalypsoServiceObs/etc/ant/build.xml" target="clean" inheritAll="false" />
        <ant antfile="${workspace}/KalypsoServiceMetaDoc/etc/ant/build.xml" target="clean" inheritAll="false" />
        <ant antfile="${workspace}/KalypsoServiceUser/etc/ant/build.xml" target="clean" inheritAll="false" />
        <ant antfile="${workspace}/KalypsoDWD/etc/ant/build.xml" target="clean" inheritAll="false" />
        <ant antfile="${workspace}/KalypsoModelTubig/etc/ant/build.xml" target="clean" inheritAll="false" />
        <ant antfile="${workspace}/KalypsoModelSaale/etc/ant/build.xml" target="clean" inheritAll="false" />
    </target>

    <target name="copy-data" depends="prepare">
        <echo message="Copy the data files to the local deploy dir" />
        <copy todir="${dist.webdav}/data">
            <fileset dir="${src.path}/data" excludes="**/CVS/**" />
        </copy>
    </target>

    <target name="copy-allconf" depends="prepare">
        <echo message="Copy the configuration for the server to deploy dir" />
        <!-- This is ok because there are currently only conf files in src.path 
	    TODO should some non-conf stuff come into this dir, then 
	         please update this target
	    -->
        <copy todir="${dist.webdav}">
            <fileset dir="${src.path}" excludes="**/CVS/**" />
        </copy>
    </target>

    <target name="co-sachsen-anhalt-models" depends="prepare">
        <echo message="Checkout the models for Sachsen-Anhalt" />

        <antcall target="co-model">
            <param name="pPackage" value="KalypsoSachsenAnhalt/Data/KalypsoBode" />
            <param name="pName" value="Bode" />
        </antcall>

    	<antcall target="co-model">
            <param name="pPackage" value="KalypsoSachsenAnhalt/Data/KalypsoIlse" />
            <param name="pName" value="Ilse" />
        </antcall>

        <antcall target="co-model">
            <param name="pPackage" value="KalypsoSachsenAnhalt/Data/KalypsoSaale" />
            <param name="pName" value="Saale" />
        </antcall>

    </target>

    <!-- Callable CVS checkout target 
		pPackage: the module to checkout
		pName: name of the Directory that will be created
	-->
    <target name="co-model">

        <pathconvert targetos="windows" property="copath">
            <path path="${dist.webdav}/prognose/${pName}" />
        </pathconvert>

        <exec executable="cmd.exe" dir=".">
            <arg line="/C start cvs-co.bat ${user.name} ${copath} ${pPackage}" />
        </exec>

        <delete includeemptydirs="true" failonerror="false">
            <!-- empty '.prognose' and 'Rechenvariante' dirs -->
            <fileset dir="${dist.webdav}/prognose/${pName}/.prognose" includes="**/*" />
            <fileset dir="${dist.webdav}/prognose/${pName}/Rechenvarianten" includes="**/*" />

            <!-- remove all '.calculation' files -->
            <fileset dir="${dist.webdav}/prognose/${pName}" includes="**/.calculation" />

            <!-- remove all CVS files -->
            <fileset dir="${dist.webdav}/prognose/${pName}" defaultexcludes="false">
                <include name="**/CVS/*" />
                <include name="**/CVS/**" />
            </fileset>

        </delete>
    </target>

    <target name="build-basic" depends="prepare">
        <echo message="Building basic projects" />

        <!-- use the central build-core script for the common projects -->
        <ant antfile="${workspace}/KalypsoBuild/central-build/build-core.xml" target="build-core" inheritAll="false" />

            <ant antfile="${workspace}/KalypsoDWD/etc/ant/build.xml"
                 target="deploy"
                 inheritAll="false" />
        
        <ant antfile="${workspace}/KalypsoServiceUser/etc/ant/project-build.xml" target="deploy" inheritAll="false" />
        <ant antfile="${workspace}/KalypsoAdapterRobotron/etc/ant/build.xml" target="deploy" inheritAll="false" />
        <ant antfile="${workspace}/KalypsoAdapterWiski/etc/ant/build.xml" target="deploy" inheritAll="false" />
    </target>

    <target name="build-UserService" depends="build-basic">
        <!-- First clean -->
        <ant antfile="${workspace}/KalypsoServiceUser/etc/ant/build.xml" target="clean" inheritAll="false">
            <property file="deploy.properties" />
        </ant>

        <!-- Copy RobotronAdapter to UserService -->
        <copy todir="${workspace}/KalypsoServiceUser/build/build-war/WEB-INF/lib">
            <fileset dir="${workspace}/KalypsoAdapterRobotron/build/deploy" includes="**/*.jar" />
        </copy>

        <!-- Finally build UserService WAR -->
        <ant antfile="${workspace}/KalypsoServiceUser/etc/ant/build.xml" target="build-war" inheritAll="false"/>
    </target>

    <target name="build-ObsService" depends="build-basic">
        <!-- First clean -->
        <ant antfile="${workspace}/KalypsoServiceObs/etc/ant/build.xml" target="clean" inheritAll="false">
            <property file="deploy.properties" />
        </ant>

        <!-- Copy WiskiAdapter to ObsService -->
        <copy todir="${workspace}/KalypsoServiceObs/build/build-war/WEB-INF/lib">
            <fileset dir="${workspace}/KalypsoAdapterWiski/build/deploy" includes="**/*.jar" />
        </copy>

        <!-- Finally build ObsService WAR -->
        <ant antfile="${workspace}/KalypsoServiceObs/etc/ant/build.xml" target="build-war" inheritAll="false"/>
    </target>

    <target name="build-CalcService" depends="build-basic">
        <!-- First clean -->
        <ant antfile="${workspace}/KalypsoServiceCalc/etc/ant/build.xml" target="clean" inheritAll="false" />

        <!-- Build calc-service client in order to resolve dependencies to model plugins -->
        <ant antfile="${workspace}/KalypsoServiceCalc/etc/ant/build.xml" target="build-client" inheritAll="false" />

        <!-- Build the plugins -->
        <ant antfile="${workspace}/KalypsoModelTubig/etc/ant/build.xml" target="deploy" inheritAll="false" />
        <ant antfile="${workspace}/KalypsoModelSaale/etc/ant/build.xml" target="deploy" inheritAll="false" />

        <!-- Copy plugins in CalcService -->
        <copy todir="${workspace}/KalypsoServiceCalc/build/build-war/WEB-INF/lib" overwrite="true">
            <fileset dir="${workspace}/KalypsoModelTubig/build/deploy" includes="**/*.jar" />
        </copy>
        <copy todir="${workspace}/KalypsoServiceCalc/build/build-war/WEB-INF/lib" overwrite="true">
  	  			<fileset dir="${workspace}/KalypsoModelSaale/build/deploy" includes="**/*.jar" />
     	</copy>

        <!-- Finally build CalcService War -->
        <ant antfile="${workspace}/KalypsoServiceCalc/etc/ant/build.xml" target="build-war" inheritAll="false"/>
    </target>

    <target name="build-MetaDocService" depends="build-basic">
        <!-- First clean -->
        <ant antfile="${workspace}/KalypsoServiceMetaDoc/etc/ant/build.xml" target="clean" inheritAll="false">
            <property file="deploy.properties" />
        </ant>

        <!-- Copy RobotronAdapter to MetaDocService -->
        <copy todir="${workspace}/KalypsoServiceMetaDoc/build/build-war/WEB-INF/lib">
            <fileset dir="${workspace}/KalypsoAdapterRobotron/build/deploy" includes="**/*.jar" />
        </copy>

        <!-- Finally build MetaDocService WAR -->
        <ant antfile="${workspace}/KalypsoServiceMetaDoc/etc/ant/build.xml" target="build-war" inheritAll="false" />
    </target>

    <target name="build-services" depends="build-CalcService,build-MetaDocService,build-ObsService,build-UserService">
        <echo message="Building all services" />
    </target>

    <target name="deploy-lhz-calcService" depends="build-CalcService">
	    <copy tofile="${dist}/Kalypso_CalculationService.war"
          file="${workspace}/KalypsoServiceCalc/build/deploy/jaxrpc-kalypsoservice_calculation.zip"
          overwrite="true" />
    </target>

    <target name="deploy-lhz"
            depends="clean,prepare,build-services,copy-allconf,copy-data,co-sachsen-anhalt-models, deploy-lhz-calcService"
            description="Deploy as File in the ${dist} dir for LHZ">
        <echo message="Copying the wars and all other stuff to ${dist} - Ready for sending to LHZ" />

        <copy tofile="${dist}/Kalypso_MetaDocService.war"
              file="${workspace}/KalypsoServiceMetaDoc/build/deploy/jaxrpc-kalypsoservice_metadoc.zip"
              overwrite="true" />
        <copy tofile="${dist}/Kalypso_ObservationService.war"
              file="${workspace}/KalypsoServiceObs/build/deploy/jaxrpc-kalypsoservice_observation.zip"
              overwrite="true" />
        <copy tofile="${dist}/Kalypso_UserService.war"
              file="${workspace}/KalypsoServiceUser/build/deploy/jaxrpc-kalypsoservice_user.zip"
              overwrite="true" />
    </target>

</project>
