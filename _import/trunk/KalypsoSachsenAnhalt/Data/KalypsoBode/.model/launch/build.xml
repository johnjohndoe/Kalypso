<project default="fake">

	<property name="modell.template.dir" value="${project.dir}/.templates/Modell" />

	<!-- - - - - - - - - - - - - - - - - - 
          target: fake                      nur damit das Projekt nicht schreit
         - - - - - - - - - - - - - - - - - -->
	<target name="fake" />

	<!-- ================================= 
          target: create              
         ================================= -->
	<target name="create" description="Erzeugt eine Rechenvariante">
		<!-- TODO -->
		<echo message="Rechenvariante anlegen: ${calc.dir}" />

		<echo message="Grunddaten und Vorlagen werden kopiert" />
		<copy todir="${calc.dir}">
			<fileset dir="${modell.template.dir}">
				<include name="modell.gml" />
				<include name="**/*.gmt" />
			</fileset>
		</copy>

		<!-- modell.gml, Info_Rechenvariant,gft (= view auf .calculation) -->
		<copy file="${project.dir}/.templates/Modell/modell.gml" tofile="${calc.dir}/modell.gml" />
		<copy file="${project.dir}/.templates/Modell/Info_Rechenvariante.gft" tofile="${calc.dir}/Info_Rechenvariante.gft" />
		<copy file="${project.dir}/.templates/Modell/wiskiimport_messung_120_h_vorhersage.gml" tofile="${calc.dir}/wiskiimport_messung_120_h_vorhersage.gml" />
		<copy file="${project.dir}/.templates/Modell/wiskiimport_messung_48_h_vorhersage.gml" tofile="${calc.dir}/wiskiimport_messung_48_h_vorhersage.gml" />
		<copy file="${project.dir}/.templates/Modell/wiskiimport_gesamt.gml" tofile="${calc.dir}/wiskiimport_gesamt.gml" />
		<copy file="${project.dir}/.templates/Modell/wiskiimport_vorhersage.gml" tofile="${calc.dir}/wiskiimport_vorhersage.gml" />

		<!-- Kartenansichten  -->
		<copy toDir="${calc.dir}/Karten/">
			<fileset dir="${project.dir}/.templates/Modell/Karten/" />
		</copy>

		<!-- Parameteransichten -->
		<copy toDir="${calc.dir}/Parameter/">
			<fileset dir="${project.dir}/.templates/Modell/Parameter/" />
		</copy>

		<!-- 
		<eclipse.refreshLocal resource="${calc.path}" depth="infinite"/>
		-->
	</target>

	<!-- ================================= 
          target: gebietsniederschlag              
         ================================= -->
	<target name="gebietsniederschlag" description="Umrechnung in Gebietsniederschlag">
		<property name="HOURS_OF_DAY" value="11" />
		<gmlProperty gmlURL="${calc.url}/.calculation">
			<property name="startsim" featurepath="ControlAssociation" featureProperty="startsimulation" />
			<property name="startforecast" featurepath="ControlAssociation" featureProperty="startforecast" />
			<property name="stopsim_48" featurepath="ControlAssociation" featureProperty="startforecast" dateoffset="48" dateoffsetfield="${HOURS_OF_DAY}" />
			<property name="stopsim_120" featurepath="ControlAssociation" featureProperty="startforecast" dateoffset="120" dateoffsetfield="${HOURS_OF_DAY}" />
		</gmlProperty>

		<gmlWeight modelurl="${calc.url}/modell.gml" featurepathtarget="PegelCollectionAssociation/PegelMember" propzmltarget="Niederschlag" proprelationweightmember="gewichtung" propweight="faktor" proprelationsourcefeature="ombrometerMember" propzmlsource="Niederschlag_gemessen" targetcontext="${calc.url}" from="${startsim}" forecastfrom="${startforecast}" to="${stopsim_48}" />
		<!--
		Das Argument targetmapping="C:\\TMP\\testMapping.gml" in der 
		gmlweight-Task bewirkt, dass der Filter als GML an die angegebene Stelle
		geschrieben wird.
		-->
	</target>

	<!-- ================================= 
          target: update              
         ================================= -->

	<target name="update" description="Holt die Zeitreihen vom Zeitreihendienst">

		<echo message="Zeitreihen aktualisieren: ${calc.dir}" />

		<property name="HOURS_OF_DAY" value="11" />

		<gmlProperty gmlURL="${calc.url}/.calculation">
			<property name="startsim" featurepath="ControlAssociation" featureProperty="startsimulation" />
			<property name="startforecast" featurepath="ControlAssociation" featureProperty="startforecast" />
			<property name="stopsim_48" featurepath="ControlAssociation" featureProperty="startforecast" dateoffset="48" dateoffsetfield="${HOURS_OF_DAY}" />
			<property name="stopsim_120" featurepath="ControlAssociation" featureProperty="startforecast" dateoffset="120" dateoffsetfield="${HOURS_OF_DAY}" />
		</gmlProperty>

		<echo message="Zeitreihen werden von WISKI geladen" />

		<copyObservation gml="${calc.url}/wiskiimport_gesamt.gml" featurePath="WiskiMember" context="${calc.url}" targetObservation="lokal" forecastfrom="${startforecast}" forecastto="${stopsim_48}">
			<source property="wiski_vergangenheit" from="${startsim}" to="${stopsim_48}" />
		</copyObservation>

		<copyObservation gml="${calc.url}/wiskiimport_messung_120_h_vorhersage.gml" featurePath="WiskiMember" context="${calc.url}" targetObservation="lokal" forecastfrom="${startforecast}" forecastto="${stopsim_120}">
			<source property="wiski_vergangenheit" from="${startsim}" to="${startforecast}" />
		</copyObservation>

		<copyObservation gml="${calc.url}/wiskiimport_messung_48_h_vorhersage.gml" featurePath="WiskiMember" context="${calc.url}" targetObservation="lokal" forecastfrom="${startforecast}" forecastto="${stopsim_48}">
			<source property="wiski_vergangenheit" from="${startsim}" to="${startforecast}" />
		</copyObservation>

		<copyObservation gml="${calc.url}/wiskiimport_vorhersage.gml" featurePath="WiskiMember" context="${calc.url}" targetObservation="lokal" forecastfrom="${startforecast}" forecastto="${stopsim_48}">
			<source property="wiski_vergangenheit" from="${startforecast}" to="${stopsim_48}" />
		</copyObservation>

	</target>

	<!-- ================================= 
          target: afterCalc              
         ================================= -->
	<target name="afterCalc" description="wird nach Beendigung der Berechnung ausgeführt" />

	<!-- ================================= 
          target: runCalculation              
         ================================= -->
	<target name="runCalculation" description="Führt die Berechnung durch">
		<kalypso.runCalculation typeID="TubigV1.0" calcCaseFolder="${calc.path}">
			<!-- Dateien relativ zur Rechenvariante (.../input/calc/) -->
			<input id="MODELL_GML" path="modell.gml" relativeToCalcCase="true" />
			<input id="CONTROL_GML" path=".calculation" relativeToCalcCase="true" />

			<!-- Verzeichnisse relativ zur Rechenvariante (.../input/calc/) -->
			<!-- optionales Attribut 'optional' könnte bei der Bode für die Speicher weg -->
			<!-- Unterverzeichnisse Messung und Vorhersage! -->
			<input id="QPegelDirIn" path="Zeitreihen/Pegel" relativeToCalcCase="true" />
			<input id="QSpeicherDirIn" path="Zeitreihen/Speicherabgabe" relativeToCalcCase="true" optional="true" />
			<!-- haben keine Unterverzeichnisse -->
			<input id="VSpeicherDirIn" path="Zeitreihen/Speicher" relativeToCalcCase="true" optional="true" />
			<input id="NsGebietDirIn" path="Zeitreihen/Gebietsniederschlag" relativeToCalcCase="true" />

			<output id="Logs" path="Log-Dateien" relativeToCalcCase="true" />
			<output id="Ergebnisse" path="" relativeToCalcCase="true" />

			<!-- Verzeichnis wird geleert, bevor die neuen Ergebnisse geholt werden -->
			<clearAfterCalc path="Log-Dateien" relativeToCalcCase="true" />
		</kalypso.runCalculation>
	</target>
</project>