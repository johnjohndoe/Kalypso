<project default="fake">

	<property name="modell.template.dir" value="${project.dir}/.templates/Modell" />

	<!-- - - - - - - - - - - - - - - - - - 
          target: fake                      nur damit das Projekt nicht schreit
         - - - - - - - - - - - - - - - - - -->
	<target name="fake" />

	<!-- ================================= 
          target: create              
         ================================= -->
	<target name="create" description="Erzeugt eine Rechenvariante">
		<!-- TODO -->
		<echo message="Rechenvariante anlegen: ${calc.dir}" />

		<echo message="Grunddaten und Vorlagen werden kopiert" />
		<copy todir="${calc.dir}">
			<fileset dir="${modell.template.dir}">
				<include name="modell.gml" />
				<include name="**/*.gmt" />
			</fileset>
		</copy>
	</target>

	<target name="update" description="Aktualisiert eine Rechenvariante">
		<echo message="Zeitreihen von WISKI laden: ${calc.dir}" />

		<kalypso.gmlProperty gmlURL="${calc.url}/.calculation">
			<property name="startforecast" featurepath="ControlAssociation" featureProperty="startforecast" />
			<!-- startsim = startforecast - 120h -->
			<property name="startsim" featurepath="ControlAssociation" featureProperty="startforecast" dateoffset="-120" dateoffsetfield="11"/>
			<!-- stopsim = startforecast + 48h -->
			<property name="stopsim" featurepath="ControlAssociation" featureProperty="startforecast" dateoffset="48" dateoffsetfield="11" />
			
			<property name="scenarioId" featurepath="ScenarioAssociation" featureProperty="scenarioId" defaultValue=""/>
		</kalypso.gmlProperty>
		
		<echo message="Szenario der Rechenvariante ist: ${scenarioId}" />
		
		<!-- Unterscheide zwischen Katastrophentest und normalem Szenario -->
		<kalypso.multiequals arg1="${scenarioId}" arg2="test">
			<!-- Links fürs Abholen der Vorhersage-Zeitreihen -->
			<property name="pegelMessungLink" valueThen="wiski_simulation_vergangenheit" valueElse="wiski_vergangenheit"/>
<!--			
			<property name="niederschlagMessungLink" valueThen="in2ObservationLink" valueElse="inObservationLink"/>
			<property name="niederschlagVorhersageLink" valueThen="in3ObservationLink" valueElse="in1ObservationLink"/>
			<property name="talsperreLink" valueThen="in1ObservationLink" valueElse="inObservationLink"/>
			<property name="vorgabeLink" valueThen="in1ObservationLink" valueElse="inObservationLink"/>
-->			
			<!-- Links für die Ablage der Vorhersage-Zeitreihen -->
<!--			
			<property name="vorhersageLinkNormal" valueThen="out3ObservationLink" valueElse="outObservationLink"/>
			<property name="vorhersageLinkOben" valueThen="out4ObservationLink" valueElse="out1ObservationLink"/>
			<property name="vorhersageLinkUnten" valueThen="out5ObservationLink" valueElse="out2ObservationLink"/>
-->			
		</kalypso.multiequals>

		<echo message="Verzeichnisse werden erstellt" />
		<mkdir dir="${calc.dir}/Durchfluß" />
		<mkdir dir="${calc.dir}/Niederschlag" />
<!--		
		<mkdir dir="${calc.dir}/Schnee" />
		<mkdir dir="${calc.dir}/Speicherinhalt" />
		<mkdir dir="${calc.dir}/Temperatur" />
-->		

		<kalypso.copyObservation gml="${project.url}/.templates/Modell/wiskiimport_durchfluß.gml" featurePath="WiskiMember" context="${calc.url}" targetObservation="lokal" forecastFrom="${startforecast}" forecastTo="${stopsim}">
			<source property="wiski_vergangenheit" from="${startsim}" to="${startforecast}" />
		</kalypso.copyObservation>

		<!-- TODO: alle anderen auch holen -->
	</target>

	<target name="runCalculation">
		<echo message="alte Ergebnisse werden gelöscht..."/>
		<delete verbose="true" includeemptydirs="true" failonerror="false">
			<fileset dir="${calc.dir}/Ergebnisse"/>
		</delete>

		<echo message="Modellrechnung wird durchgeführt: ${calc.dir}" />
		<kalypso.runCalculation calccasefolder="${calc.path}" typeid="Saale_SA_V1">
			<input id="CONTROL" path=".calculation" relativeToCalcCase="true" />
			<input id="MODELL" path="modell.gml" relativeToCalcCase="true" />

			<!--  implizit benötigte Daten (=Zeitreihen); id ist unwichtig -->

			<input id="Durchfluß" path="Durchfluß" relativeToCalcCase="true"  />
			<input id="Niederschlag" path="Niederschlag" relativeToCalcCase="true" />
			<input id="Schnee" path="Schnee" relativeToCalcCase="true" optional="true"/>
			<input id="Speicherinhalt" path="Speicherinhalt" relativeToCalcCase="true" />

			<output id="LOG" path="Ergebnisse/Input_Output.log" relativeToCalcCase="true" />
			<output id="ZML_RESULT" path="Ergebnisse" relativeToCalcCase="true" />
			<output id="HWVOR00_LOG" path="Ergebnisse/HWQVOR.TXT" relativeToCalcCase="true"/>
		</kalypso.runCalculation>

	</target>
</project>