<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="KalypsoConfLocalhost: server" default="redeploy-services" basedir=".">

	<!-- 
		Description: central build file for the Sachsen Project.
		
		Targets which have a description element are so-called public-targets,
		that is, targets that you (the deployer) are more likely to use
		to deploy the files. Public targets appear with a dark green circle
		in the ant-outline and the ant-view (other targets are light green).
		
		The default target is the deploy target to use when deploying for
		the LFUG.
		
		______________________________________________________________________
		Checklist:
		
		: Server-Deploy for BCE :
		1. deploy-data
		2. deploy-models
		3. deploy-services
		
		: Server-Deploy for LFUG :
		1. deploy-lfug
		
		______________________________________________________________________
		Or, when in the development process (only within BCE):
		
		* redeploy-services
		* redeploy-XXXService
	-->
		
	<property name="project.path" value="${workspace}/KalypsoConfLocalhost" />
	<property name="src.path" value="${project.path}/deployable-server/webdav" />

	<property name="dist" value="${project.path}/deploy/server" />
	<property name="dist.webdav" value="${dist}/webdav" />
	<property name="dist.data" value="${dist.webdav}/data" />
	<property name="dist.prognose" value="${dist.webdav}/prognose" />
	<property name="dist.srvconf" value="${dist.webdav}/srvconf" />
	<property name="dist.vorhersageconf" value="${dist.webdav}/vorhersageconf" />
	
	<property file="deploy.properties"/>
	<property name="deploy.webdav" value="${tomcat.server.cataling_home}\\webapps\\webdav"/>

	<target name="prepare">
		<echo message="Creating the required directories...." />
		<mkdir dir="${dist}" />
		<mkdir dir="${dist.webdav}" />
		<mkdir dir="${dist.data}" />
		<mkdir dir="${dist.prognose}" />
		<mkdir dir="${dist.srvconf}" />
		<mkdir dir="${dist.vorhersageconf}" />
	</target>

	<target name="clean">
		<echo message="Cleaning all subprojects..." />
		<delete dir="${dist}" />
		<ant antfile="${workspace}/KalypsoBuild/central-build/build-core.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoCalcService/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoMetaDocService/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoObsService/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoUserService/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoOptimizePlugin/etc/ant/build.xml" target="clean" inheritAll="false" />
<!--
		<ant antfile="${workspace}/KalypsoSpreePlugin/etc/ant/build.xml" target="clean" inheritAll="false" />
-->
		<ant antfile="${workspace}/KalypsoNA/etc/ant/build.xml" target="clean" inheritAll="false" />
		<ant antfile="${workspace}/KalypsoPSICompactAdapter/etc/ant/build.xml" target="clean" inheritall="false" />
		<ant antfile="${workspace}/KalypsoPSICompactImpl/build.xml" target="clean" inheritall="false" />
	</target>

	<target name="copy-data" depends="prepare">
		<echo message="Copy the data files to the local deploy dir" />
		<copy todir="${dist.data}">
			<fileset dir="${src.path}/data" excludes="**/CVS/**" />
		</copy>
	</target>

	<target name="copy-allconf" depends="prepare">
		<echo message="Copy the configuration for the server to deploy dir" />
		<copy todir="${dist.srvconf}">
			<fileset dir="${src.path}/srvconf" excludes="**/CVS/**" />
		</copy>
		<copy todir="${dist.vorhersageconf}">
			<fileset dir="${src.path}/vorhersageconf" excludes="**/CVS/**" />
		</copy>
		<copy todir="${dist}">
			<fileset file="${src.path}/kalypso-client.ini" />
		</copy>
	</target>
<!--
	<target name="co-sachsen-models" depends="prepare">
		<echo message="Checkout the models for Sachsen" />

		<antcall target="co-model">
			<param name="pPackage" value="KalypsoData/KalypsoSpree" />
			<param name="pName" value="Spree" />
		</antcall>

		<antcall target="co-model">
			<param name="pPackage" value="KalypsoData/KalypsoWeisseElster" />
			<param name="pName" value="WeisseElster" />
		</antcall>

	</target>
-->
	<!-- Callable CVS checkout target 
		pPackage: the module to checkout
		pName: name of the Directory that will be created
	-->
	<target name="co-model">

		<pathconvert targetos="windows" property="copath">
			<path path="${dist.prognose}/${pName}" />
		</pathconvert>

		<exec executable="cmd.exe" dir="${project.path}/deployable-server">
			<arg line="/C start ${project.path}/deployable-server/cvs-co.bat ${user.name} ${copath} ${pPackage}" />
		</exec>

		<delete includeemptydirs="true">
			<!-- empty '.prognose' and 'Rechenvariante' dirs -->
			<fileset dir="${dist.prognose}/${pName}/.prognose" includes="**/*" />
			<fileset dir="${dist.prognose}/${pName}/Rechenvarianten" includes="**/*" />

			<!-- remove all '.calculation' files -->
			<fileset dir="${dist.prognose}/${pName}" includes="**/.calculation" />

			<!-- remove all CVS files -->
			<fileset dir="${dist.prognose}/${pName}" defaultexcludes="false">
				<include name="**/CVS/*" />
				<include name="**/CVS/**" />
			</fileset>

		</delete>
	</target>

	<target name="build-basic" depends="prepare">
		<echo message="Building basic projects" />
		
		<!-- use the central build-core script for the common projects -->
		<ant antfile="${workspace}/KalypsoBuild/central-build/build-core.xml" target="build-core" inheritAll="false" />
		
		<ant antfile="${workspace}/KalypsoDWD/etc/ant/build.xml" target="deploy" inheritAll="false" />
	</target>

	<target name="build-plugins" depends="build-basic, build-CalcService">
		<echo message="Building specific plugins for Sachsen" />
		<ant antfile="${workspace}/KalypsoOptimizePlugin/etc/ant/build.xml" target="deploy" inheritAll="false" />
<!--
		<ant antfile="${workspace}/KalypsoSpreePlugin/etc/ant/build.xml" target="deploy" inheritAll="false" />
-->
		<ant antfile="${workspace}/KalypsoNA/etc/ant/build.xml" target="deploy" inheritAll="false" />

	</target>

	<target name="modelplugins-dependency" depends="build-plugins">
		<echo message="Copying the libs relevant for using Spree-Plugin and NA-Plugin" />

<!--
	   <copy todir="${workspace}/KalypsoCalcService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/KalypsoSpreePlugin/build/deploy" includes="**/*.jar" />
		</copy>
-->

		<copy todir="${workspace}/KalypsoCalcService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/KalypsoNA/build/deploy" includes="**/*.jar" />
		</copy>

		<copy todir="${workspace}/KalypsoCalcService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/KalypsoOptimizePlugin/build/deploy" includes="**/*.jar" />
		</copy>
	</target>

	<target name="psicompact-fake" depends="prepare, build-basic">
		<echo message="Integrating the fake implementation of PSICompact" />
		<delete file="${workspace}/KalypsoPSICompactAdapter/lib/PSICompact.jar" />
		<ant antfile="${workspace}/KalypsoPSICompactImpl/build.xml" target="deploy" inheritall="false" />
		<ant antfile="${workspace}/KalypsoPSICompactAdapter/etc/ant/build.xml" target="deploy" inheritall="false" />
	</target>

	<target name="psicompact-echte" depends="prepare, build-basic">
		<echo message="Integrating the real implementation of PSICompact" />
		<copy file="${project.path}/deployable-server/echte-psicompact/PSICompact.jar" tofile="${workspace}/KalypsoPSICompactAdapter/lib/PSICompact.jar" overwrite="true" />
		<ant antfile="${workspace}/KalypsoPSICompactAdapter/etc/ant/build.xml" target="deploy" inheritall="false" />
	</target>

	<target name="build-UserService" depends="build-basic">
		<ant antfile="${workspace}/KalypsoUserService/etc/ant/build.xml" target="build-war" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="build-ObsService" depends="build-basic">
		<ant antfile="${workspace}/KalypsoObsService/etc/ant/build.xml" target="build-war" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<copy todir="${workspace}/KalypsoObsService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/KalypsoPSICompactAdapter/build/deploy" includes="**/*.jar" />
		</copy>
	</target>

	<target name="build-CalcService" depends="build-basic">
		<!-- Build client in order to resolve dependencies to model plugins -->
		<ant antfile="${workspace}/KalypsoCalcService/etc/ant/build.xml" target="build-client" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<ant antfile="${workspace}/KalypsoCalcService/etc/ant/build.xml" target="build-war" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="build-MetaDocService" depends="build-basic">
		<ant antfile="${workspace}/KalypsoMetaDocService/etc/ant/build.xml" target="build-war" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<copy todir="${workspace}/KalypsoMetaDocService/build/build-war/WEB-INF/lib">
			<fileset dir="${workspace}/KalypsoPSICompactAdapter/build/deploy" includes="**/*.jar" />
		</copy>
	</target>

	<target name="build-services-dev" depends="psicompact-fake,build-CalcService,build-MetaDocService,build-ObsService,build-UserService,build-plugins,modelplugins-dependency">
		<echo message="Building all services" />
	</target>

	<target name="deploy-allconf" depends="copy-allconf">
		<echo message="Deploying all conf stuff to ${tomcat.server}" />

		<copy todir="${deploy.webdav}\\srvconf" overwrite="true">
			<fileset dir="${dist.srvconf}" excludes="**/CVS/**" />
		</copy>
		<copy todir="${deploy.webdav}\\vorhersageconf" overwrite="true">
			<fileset dir="${dist.vorhersageconf}" excludes="**/CVS/**" />
		</copy>
		<copy todir="${deploy.webdav}" overwrite="true">
			<fileset file="${dist}/kalypso-client.ini" />
		</copy>
	</target>

	<target name="deploy-data" depends="copy-data"  description="Deploy the data (Observation repositories)">
		<echo message="Deploy the data files to ${tomcat.server}" />

		<copy todir="${deploy.webdav}\\data" overwrite="true">
			<fileset dir="${dist.data}" excludes="**/CVS/**" />
		</copy>
	</target>

<!--
  <target name="deploy-models" depends="co-sachsen-models" description="Deploy the models">
		<echo message="Deploy the models on ${tomcat.server}" />

		<copy todir="${deploy.webdav}\\prognose" overwrite="true">
			<fileset dir="${dist.prognose}" excludes="**/CVS/**" />
		</copy>
	</target>
-->
	<target name="deploy-services" depends="deploy-allconf,build-services-dev" description="Deploy (first time) all services and configuration">
		<echo message="Deploying all services to ${tomcat.server}" />

		<ant antfile="${workspace}/KalypsoCalcService/etc/ant/build.xml" target="deploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<ant antfile="${workspace}/KalypsoMetaDocService/etc/ant/build.xml" target="deploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<ant antfile="${workspace}/KalypsoObsService/etc/ant/build.xml" target="deploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
		<ant antfile="${workspace}/KalypsoUserService/etc/ant/build.xml" target="deploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="redeploy-UserService" depends="psicompact-fake,build-UserService,deploy-allconf" description="Redeploy service and configuration">
		<echo message="Redeploying User Service" />
		<ant antfile="${workspace}/KalypsoUserService/etc/ant/build.xml" target="redeploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="redeploy-ObsService" depends="psicompact-fake,build-ObsService,deploy-allconf" description="Redeploy service and configuration">
		<echo message="Redeploying Observation Service" />
		<ant antfile="${workspace}/KalypsoObsService/etc/ant/build.xml" target="redeploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="redeploy-MetaDocService" depends="psicompact-fake,build-MetaDocService,deploy-allconf" description="Redeploy service and configuration">
		<echo message="Redeploying MetaDoc Service" />
		<ant antfile="${workspace}/KalypsoMetaDocService/etc/ant/build.xml" target="redeploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="redeploy-CalcService" depends="psicompact-fake,modelplugins-dependency,deploy-allconf" description="Redeploy service and configuration">
		<echo message="Redeploying Calculation Service" />
		<ant antfile="${workspace}/KalypsoCalcService/etc/ant/build.xml" target="redeploy" inheritAll="false">
			<property file="deploy.properties" />
		</ant>
	</target>

	<target name="redeploy-services" depends="redeploy-UserService,redeploy-ObsService,redeploy-CalcService,redeploy-MetaDocService" description="Redeploy services and their configuration">
		<echo message="Redeploying all services" />
	</target>

	<target name="build-services-lfug" depends="psicompact-echte,build-CalcService,build-MetaDocService,build-ObsService,build-UserService,build-plugins,modelplugins-dependency">
		<echo message="Build for LFUG (using real PSICompact)" />
	</target>

<!--
  <target name="deploy-lfug" depends="clean,prepare,build-services-lfug,copy-allconf,copy-data,co-sachsen-models" description="Deploy as File in the ${dist} dir for LFUG">
		<echo message="Copying the wars and all other stuff to ${dist} - Ready for sending to LFUG" />

		<copy tofile="${dist}/Kalypso_CalculationService.war" file="${workspace}/KalypsoCalcService/build/deploy/jaxrpc-kalypsoservice_calculation.zip" overwrite="true" />
		<copy tofile="${dist}/Kalypso_MetaDocService.war" file="${workspace}/KalypsoMetaDocService/build/deploy/jaxrpc-kalypsoservice_metadoc.zip" overwrite="true" />
		<copy tofile="${dist}/Kalypso_ObservationService.war" file="${workspace}/KalypsoObsService/build/deploy/jaxrpc-kalypsoservice_observation.zip" overwrite="true" />
		<copy tofile="${dist}/Kalypso_UserService.war" file="${workspace}/KalypsoUserService/build/deploy/jaxrpc-kalypsoservice_user.zip" overwrite="true" />
	</target>
-->
</project>
