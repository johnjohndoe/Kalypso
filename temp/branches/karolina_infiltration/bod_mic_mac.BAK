!     Last change:  KV   16 Sep 2008    4:07 pm

!
! This code is part of the library 'Kalypso-NA'.
! KALYPSO-NA is a deterministic, non-linear, detailed Rainfall-Runoff-Model (RRM).
! The model permits a complete simulation of the land bound
! part of the global water balance as aw reaction on observed precipitation events.
! Copyright (C) 2004  HAMBURG UNIVERSITY OF TECHNOLOGY, Department of River and
! Coastal Engineering (in co-operation with Bjoernsen Cunsulting Engineers)
!
! This library is free software; you can redistribute it and/or
! modify it under the terms of the GNU Lesser General Public License
! as published by the Free Software Foundation, version 2.1.
!
! This library is distributed in the hope that it will be useful,
! but WITHOUT ANY WARRANTY; without even the implied warranty of
! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
! Lesser General Public License for more details.
!
! You should have received a copy of the GNU Lesser General Public
! License along with this library; if not, write to the Free Software
! Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
!
! For information please contact:
! HAMBURG UNIVERSITY OF TECHNOLOGY, Department of River and
! Coastal Engineering. Denickestr. 22, 21073 Hamburg, Germany.
! Dipl.-Ing. Jessica Hübsch:   phone: +49 40 42878 4181 mail: j.huebsch@tuhh.de
! See our web page: www.tuhh.de/wb
!
!
! HAMBURG UNIVERSITY OF TECHNOLOGY, Department of River and
! Coastal Engineering, hereby disclaims all copyright interest in
! the library 'Kalypso-NA'.
!
! Jessica Hübsch, 16 August 2004
! Research Associate
!
!***********************************************************************************************
   subroutine bod_mic_mac(kzif,dt,t,it,pr,ilay,epot,wp,nfk,bmax,bof,eva,inf,perk, &
                 alpha,kf,n,l,m_tief,nb,nn,nv,itime,m_retlay,                     &
                 Imicc_real,infm,Imic_real,Imicpot,Imic,kh1,infl,cex)


!**************************************ÄNDERUNGEN***********************************************


!     Date      Programmer      	Description of change
!     ====      ==========      	=====================
!  19.08.2005   Karolina-Villagra       Addition of infiltration calculation by bronstert and van Genuchten:
!                                       by calculation of micro and macropores in upper soil layers and
!                                       unsaturated hydraulic conductivity by pF curve approach


!***************************************BESCHREIBUNG********************************************
!c    Infiltration by micro and macro pores calculation
!c
!c
!c
!***************************************EIN-/AUSGABE********************************************
!c    Eingabe:
!c		kzif	=1 akt. evapotranspiration linear aus bodenfeuchte
!c		     	=2   "     "   nach wendling entsp. DVWK-empfehltung
!c		dt      zeitschrittweite  (h)
!c     		pr	niederschlag abzuegl.interzeption (mm)
!               peff    effective precipitation (mm/h)
!c     		epot	potentielle verdunstung (mm)
!c     		kap	kapilare aufstiegsrate (mm)
!c              wp      wilting point (mm)
!c     		bmax	nutzbare max.bodenfeuchte  (mm)
!c     		nfk	nutzbare feldkapazitaet    (mm)
!c
!c
!c     		bof	bodenfeuchte aus zeitschritt t-1 (mm)
!c              m_bf0   initial soil moisture
!               wcr     residual soil moisture (mm)
!               wcs     saturated soil moisture (mm)
!c              n       van Genuchten parameter
!               l       pore connectivity (-)
!c              alpha   van Genuchten parameter  (1/cm)
!c              vmacro  total volume of macropores (fraction of %)
!               r       average radial distance between macropores (cm)
!c              wt_c    root depth  (m)
!c              vmacro water content in macropores    (mm)
!c              kff     saturated hydraulic conductivity (mm/d)
!c              it      counter
!               sumhz   sum of water content in macropores per hydrotop (mm)
!               sumhzz  sum water content in macropores per hydrotop per layer (mm)
!               sumtief sum of the thickness of soil profile  (mm)
!               m_tief  thickness of soil layer  (dm)
!               hz      water content in macropores (mm)
!               hoo     excess water content in macropores (return flow!!) (mm)
!
!c
!c    Ausgabe:
!c
!c     		bof	bodenfeuchte  zeitschritt t (mm)
!c		inf     aktuelle infiltration          (mm)
!               infm    infiltration (with macropores) (mm)
!c		eva        "     verdunstung aus boden (mm)
!c		perk       "     durchsickerung        (mm)
!               Imicc_real 	real infiltration in soil matrix (mm)
!               Imac_mic        interaction macro-micro pores (mm)
!               Imacc_real      real infiltration in macropores (mm)
!c
!******************************************VARIABLEN********************************************

      USE generic_LOGGER
      USE Units

      IMPLICIT NONE
      include	'include\param.cmn'
      include      'include\is.cmn'

      INTEGER, INTENT(IN):: kzif,t,it,ilay,nb,nn,nv,itime
      REAL,INTENT(IN):: dt,pr,m_tief(maxlay,idimnutz2),m_retlay(maxlay,idimnutz2), &
                        epot
      REAL,INTENT(IN)::wp,bmax,nfk,kf
      REAL,INTENT(IN)::n,alpha,l

      INTEGER::itime_max,ndx

      REAL:: bof,bofneu,bof_end(maxndx,maxlay,2*idimnutz2),bof_kho(maxndx,maxlay,2*idimnutz2), &
             bof_extra,bof_layer,bof_ho,bof_ilay
      REAL:: intflow
      REAL:: overlandflow
      REAL:: eva

      REAL:: h_low

      REAL:: Imic_real(2*idimnutz2,maxlay,idim),Imicpot(2*idimnutz2,maxlay,idim), &
             inf,infm,infl,Imicc_real,Imic

      REAL:: perk,cex
      REAL:: kcita

      REAL:: evapo(maxndx,2*idimnutz2)

      REAL:: kunsat(maxndx,2*idimnutz2),kh1

      REAL:: diff_percc(maxndx,maxlay,2*idimnutz2),diff_bho(maxndx,maxlay,2*idimnutz2)

      REAL:: sumImic_real(maxlay,idimnutz2)

      REAL:: boderr

!******************************************ANWEISUNGEN******************************************

bofneu = 0.
intflow=0.
inf=0.


!-----------------------------------------------------------------------------------------------
 write (nres,*)'t',t
 write (nres,*)'dt',dt
 write (nres,*)'bofini',bof

 write (nres,*)'pr',pr
 write (nres,*)'it',it
 write (nres,*)'ilay',ilay

!-----------------------------------------------------------------------------------------------
! calculate soil moisture

call inf_mic(dt,pr,Imic_real,m_tief,wp,bmax,nfk,alpha,kf,n,l,ilay,nb, &
              bof,nn,t,perk,kcita,it,bof_end,bof_kho,cex,bof_extra,     &
              m_retlay,diff_percc,diff_bho,bof_layer,kzif,epot,evapo,bof_ho,kunsat, &
              sumImic_real,kh1,itime,h_low,Imicpot,overlandflow,boderr, &
              bof_ilay,itime_max,eva,ndx)

infm=Imic_real(nn,ilay,it)

!if ((pr+bof_extra) .gt. Imic_real(nn,ilay,it)) then
!       call inf_mac(t,ilay,nb,nn,nv,it,itime,dt,pr,infm,wt_c,m_tief,kh1,&
!                      h_low,kff,sumhzz,vmacro,r,hz,Imic_real,Imic_pot,Imac,Imac_mic,nres,returnflow,&
!                      nfk,cex,bmax,perk,bof_layer,itime_max,bof_extra,cind,cinh)

!end if

inf=Imic_real(nn,ilay,it)!+Imac(nn,ilay,it)+Imac_mic(nn,ilay,it)
!write (nres,*)'pr',pr
!write (nres,*)'Imic',Imic_real(nn,ilay,it)
!write (nres,*)'Imac',Imac(nn,ilay,it)
!write (nres,*)'bof_layer2',bof_layer
!inf=Imic_real(nn,ilay,it)
!boderr=boderrr-bof_layer+inf-perk
! write (nres,*)'inf_total',inf
if(abs(boderr).gt.0.1) then
  write (nres,*)'boderr',boderr
  !write (nres,*)'Imac',Imac(nn,ilay,it)
  write (nres,*)'pr',pr
  write (nres,*)'Imic',Imic_real(nn,ilay,it)
  write (nres,*)'perk',perk
  write (nres,*)'bof',bof_layer
  write (nres,*)'nn',nn

END if

       bofneu=bof_layer


      bof=bofneu

      Imicc_real=Imic_real(nn,ilay,t)

      Imic=Imic_real(nn,ilay,t)
      !Imac_real=Imac(nn,ilay,it)
      infl=inf
      intflow=bof_extra!+returnflow

      return

!**********************************FEHLERMELDUNGEN UND FORMATE*****************************************
1001  FORMAT (/ 1X, 'Fehler2 in bodf_n. kor. von eva!' /&
      	      & 1X, 'Bodenfeuchte negativ!'/&
              & 1X, 'Startwerte von aktuellem Modell erzeugt?')

!******************************************************************************************************
 end
