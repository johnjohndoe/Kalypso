<project default="fake">

	<property name="modell.template.dir" value="${project.dir}/.templates/Modell" />

	<!-- - - - - - - - - - - - - - - - - - 
          target: fake                      nur damit das Projekt nicht schreit
      - - - - - - - - - - - - - - - - - -->
	<target name="fake" />

	<target name="info">
		<echo message="project dir ${project.dir}" />
		<echo message="project url ${project.url}" />
		<echo message="calc dir    ${calc.dir}" />
		<echo message="calc url    ${calc.url}" />
	</target>

	<!-- 
		 ================================= 
          target: create			Rechenvariante erzeugen
         ================================= 
    -->
	<target name="create" description="Creating the calculation case">
		<echo message="Rechenvariante anlegen: ${calc.dir}" />
		
		<!-- copy others -->
		<copy todir="${calc.dir}">
			<fileset dir="${project.dir}/.model/calcCaseTemplate" includes="*/**" excludes="**/.svn/**" />
		</copy>

		<!-- copy models -->
		<copy todir="${calc.dir}/.models">
			<fileset dir="${project.dir}/Basis/.models" includes="*.gml" excludes="**/.svn/**" />
		</copy>
		
        <!-- Put some default values into calculation.gml -->
        <kalypso.changeGml gmlURL="${calc.url}/.models/calculation.gml" createQName="{org.kalypso.na.control_v2}NAControl">
          <property featurepath="" featureProperty="editor" value="${user.name}" />
          <property featurepath="" featureProperty="creationTime" value="${kalypso.currentTime}" />
        </kalypso.changeGml>		
	</target>

	<target name="setBasicModel" description="Ersetzt das Basismodell durch das Modell in der Rechenvariante">
		<echo message="Rechenvariante als Basismodell Ã¼bernehmen: ${calc.dir}" />

		<copy file="${calc.dir}/.models/modell.gml" tofile="${project.dir}/Basis/.models/modell.gml" overwrite="true" />
        <copy file="${calc.dir}/.models/hydrotop.gml" tofile="${project.dir}/Basis/.models/hydrotop.gml" overwrite="true" />
		<copy file="${calc.dir}/.models/parameter.gml" tofile="${project.dir}/Basis/.models/parameter.gml" overwrite="true" />

		<eclipse.refreshLocal resource="${project.path}/Basis/.models" depth="one" />
	</target>
	
	<!--
        =================================
        target: runCalculation
        =================================
      -->
	<target name="runCalculation" description="Runs the simulation">
		<echo message="Simulation is running: ${calc.path}" />
		<kalypso.runCalculation calcCaseFolder="${calc.path}" typeid="KalypsoNA">
			<input id="MetaSteuerdaten" path=".models/calculation.gml" relativeToCalcCase="true" />
			<input id="Modell" path=".models/modell.gml" relativeToCalcCase="true" />
			<input id="Control" path=".models/expertControl.gml" relativeToCalcCase="true" />
			<input id="Hydrotop" path=".models/hydrotop.gml" relativeToCalcCase="true" />
			<input id="Parameter" path=".models/parameter.gml" relativeToCalcCase="true" />

            <input id="NiederschlagDir" path="Precipitation" relativeToCalcCase="true" />
            <input id="KlimaDir" path="Climate" relativeToCalcCase="true" />

            <input id="ZuflussDir" path="Tributary" relativeToCalcCase="true" />
			<input id="PegelDir" path="Gauge" relativeToCalcCase="true" />
			<input id="ErgebnisDir" path="Results" relativeToCalcCase="true" />
			<input id="LZSIM_IN" path="InitialValues" relativeToCalcCase="true" />

			<output id="OUT_ZML" path="Results" relativeToCalcCase="true" />

			<clearAfterCalc path="Results/Aktuell" relativeToCalcCase="true" />
		</kalypso.runCalculation>
		<antcall target="copyResults" />
	</target>

	<!-- ================================= 
          target: copyResults   copy results to timestamped dir             
         ================================= -->
	<target name="copyResults" description="Copies the results into a time-stamped folder.">
		<tstamp>
			<format property="now" pattern="yyyy.MM.dd_(HH_mm_ss)" />
		</tstamp>

		<property name="result.path" value="${calc.path}/Results" />
		<property name="result.dir" value="${calc.dir}/Results" />

		<property name="result.path.aktuell" value="${result.path}/Aktuell" />
		<property name="result.dir.aktuell" value="${result.dir}/Aktuell" />

		<property name="result.dir.time" value="${result.dir}/${now}" />
		<property name="result.path.time" value="${result.path}/${now}" />

		<echo message="Writing copy of results to: ${result.path.time}" />
		<copy todir="${result.dir.time}">
			<fileset dir="${result.dir.aktuell}" includes="**/*" />
		</copy>
	</target>
</project>