<project default="fake">

	<property name="modell.template.dir" value="${project.dir}/.templates/Modell" />

	<!-- - - - - - - - - - - - - - - - - - 
          target: fake                      nur damit das Projekt nicht schreit
      - - - - - - - - - - - - - - - - - -->
	<target name="fake" />

	<target name="info">
		<echo message="project dir ${project.dir}" />
		<echo message="project url ${project.url}" />
		<echo message="calc dir    ${calc.dir}" />
		<echo message="calc url    ${calc.url}" />
	</target>

	<!-- 
		 ================================= 
          target: create			Rechenvariante erzeugen
         ================================= 
    -->
	<target name="create" description="Erzeugt eine Rechenvariante">
		<echo message="Rechenvariante anlegen: ${calc.dir}" />
		
		<!-- copy others -->
		<copy todir="${calc.dir}">
			<fileset dir="${project.dir}/.model/calcCaseTemplate" includes="*/**" excludes="**/.svn/**" />
		</copy>
		
		<!-- copy models -->
		<copy todir="${calc.dir}/.models">
			<fileset dir="${project.dir}/Basis/.models" includes="*.gml" excludes="**/.svn/**" />
		</copy>
		
		<!-- Put some default values into calculation.gml -->
	    <kalypso.changeGml gmlURL="${calc.url}/.models/calculation.gml" createQName="{org.kalypso.na.control_v2}NAControl">
	      <property featurepath="" featureProperty="editor" value="${user.name}" />
	      <property featurepath="" featureProperty="creationTime" value="${kalypso.currentTime}" />
	    </kalypso.changeGml>
	</target>

	<target name="setProperties" depends="info">
		<echo message="Variablen einrichten" />
		<kalypso.gmlProperty gmlURL="${calc.url}/.models/calculation.gml">
			<property name="startsim" featurepath="/" featureProperty="startsimulation" />
			<property name="stopsim" featurepath="/" featureProperty="endsimulation" />
			<property name="interval.amount" featurepath="/" featureProperty="minutesTimestep" />
		</kalypso.gmlProperty>

		<echo message="von           ${startsim}" />
		<echo message="bis           ${stopsim}" />

		<!-- correct times for filters -->
		<script language="javascript">
			intervalAmount = java.lang.Integer.parseInt(project.getProperty("interval.amount"));
			startsimTime = javax.xml.bind.DatatypeConverter.parseDateTime( startsim );
			startsimTime.add(java.util.Calendar.MINUTE, -intervalAmount);
			project.setProperty("startsim", javax.xml.bind.DatatypeConverter.printDateTime( startsimTime ));
			
			stopsimTime = javax.xml.bind.DatatypeConverter.parseDateTime( stopsim );
			stopsimTime.add(java.util.Calendar.MINUTE, 3*intervalAmount);
			project.setProperty("stopsim", javax.xml.bind.DatatypeConverter.printDateTime( stopsimTime ));
		</script>
	</target>

	<target name="updateOmbrometer" depends="setProperties">
		<!-- updateOmbrometer: ombrometer von Datacenter (oder lokal)-abholen -->
		<echo message="aktualisiere Ombrometer Zeitreihen im Rechenfall" />
		<delete dir="${calc.dir}/Niederschlag" />
		<mkdir dir="${calc.dir}/Niederschlag" />
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/ombrometer.gml" featurePath="ombrometerMember" context="${calc.url}" targetobservationdir="${calc.dir}/Niederschlag" >
			<source property="NRepository" from="${startsim}" to="${stopsim}" />
		</kalypso.copyObservation>
	</target>

	<target name="updatePegelMessung" depends="setProperties">
		<echo message="aktualisiere Pegel (Messung)" />
		<delete dir="${calc.dir}/Pegel" />
		<mkdir dir="${calc.dir}/Pegel" />
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/ObsQMapping.gml" featurePath="mappingMember" context="${calc.url}" targetobservationdir="${calc.dir}/Pegel">
			<source property="inObservationLink" from="${startsim}" to="${stopsim}" />
		</kalypso.copyObservation>
	</target>

	<target name="updateZuflussMessung" depends="setProperties">
		<echo message="aktualisiere Zufluesse (Messung)" />
		<delete dir="${calc.dir}/Zufluss" />
		<mkdir dir="${calc.dir}/Zufluss" />
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/ObsQZuMapping.gml" featurePath="mappingMember" context="${calc.url}" targetobservationdir="${calc.dir}/Zufluss">
			<source property="inObservationLink" from="${startsim}" to="${stopsim}" />
		</kalypso.copyObservation>
	</target>

	<target name="updateObsT" depends="setProperties">
		<echo message="aktualisiere Temperaturen (Messung)" />
		<delete dir="${calc.dir}/Klima" />
		<mkdir dir="${calc.dir}/Klima" />
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/ObsTMapping.gml" featurePath="mappingMember" context="${calc.url}" targetobservationdir="${calc.dir}/Klima">
			<source property="inObservationLink" from="${startsim}" to="${stopsim}" />
		</kalypso.copyObservation>
	</target>

	<target name="updateObsE" depends="setProperties">
		<echo message="aktualisiere Verdunstung (Messung)" />
		<kalypso.copyObservation gml="${project.url}/.model/observationConf/ObsEMapping.gml" featurePath="mappingMember" context="${calc.url}" targetobservationdir="${calc.dir}/Klima">
			<source property="inObservationLink" from="${startsim}" to="${stopsim}" />
		</kalypso.copyObservation>
	</target>
	
	<target name="updateAll" depends="updateOmbrometer,updatePegelMessung,updateObsT,updateObsE,updateZuflussMessung" description="Aktualisiert eine Rechenvariante">
		<echo message="aktualisiere alle Zeitreihen: ${calc.dir}" />
	</target>

	<target name="update" depends="updateAll" description="Aktualisiert eine Rechenvariante">
		<echo message="aktualisiere Zeitreihen: ${calc.dir}" />
	</target>

	<target name="setBasicModel" description="Ersetzt das Basismodell durch das Modell in der Rechenvariante">
		<echo message="Rechenvariante als Basismodell übernehmen: ${calc.dir}" />

		<copy file="${calc.dir}/.models/modell.gml" tofile="${project.dir}/Basis/.models/modell.gml" overwrite="true" />
        <copy file="${calc.dir}/.models/hydrotop.gml" tofile="${project.dir}/Basis/.models/hydrotop.gml" overwrite="true" />
		<copy file="${calc.dir}/.models/parameter.gml" tofile="${project.dir}/Basis/.models/parameter.gml" overwrite="true" />

		<eclipse.refreshLocal resource="${project.path}/Basis/.models" depth="one" />
	</target>
	<!--
        =================================
        target: runCalculation
        =================================
      -->
	<target name="runCalculation" depends="setProperties" description="Führt die eigentliche Simulationsrechnung durch">
		<echo message="Berechnung wird durchgeführt: ${calc.path}" />
		<kalypso.runCalculation calcCaseFolder="${calc.path}" typeid="KalypsoNA">
			<input id="MetaSteuerdaten" path=".models/calculation.gml" relativeToCalcCase="true" />
			<input id="Modell" path=".models/modell.gml" relativeToCalcCase="true" />
			<input id="Control" path=".models/expertControl.gml" relativeToCalcCase="true" />
			<input id="Hydrotop" path=".models/hydrotop.gml" relativeToCalcCase="true" />
			<input id="Parameter" path=".models/parameter.gml" relativeToCalcCase="true" />

			<input id="NiederschlagDir" path="Niederschlag" relativeToCalcCase="true" />
			<input id="KlimaDir" path="Klima" relativeToCalcCase="true" />
			<input id="ZuflussDir" path="Zufluss" relativeToCalcCase="true" />
			<input id="PegelDir" path="Pegel" relativeToCalcCase="true" />
			<input id="ErgebnisDir" path="Ergebnisse" relativeToCalcCase="true" />
			<input id="LZSIM_IN" path="Anfangswerte" relativeToCalcCase="true" />

			<output id="OUT_ZML" path="Ergebnisse" relativeToCalcCase="true" />

			<clearAfterCalc path="Ergebnisse/Aktuell" relativeToCalcCase="true" />
		</kalypso.runCalculation>
		<antcall target="copyResults" />
	</target>

	<!-- ================================= 
          target: copyResults   copy results to timestamped dir             
         ================================= -->
	<target name="copyResults" description="Copies the results into a time-stamped folder.">
		<tstamp>
			<format property="now" pattern="yyyy.MM.dd_(HH_mm_ss)" />
		</tstamp>

		<property name="result.path" value="${calc.path}/Ergebnisse" />
		<property name="result.dir" value="${calc.dir}/Ergebnisse" />

		<property name="result.path.aktuell" value="${result.path}/Aktuell" />
		<property name="result.dir.aktuell" value="${result.dir}/Aktuell" />

		<property name="result.dir.time" value="${result.dir}/${now}" />
		<property name="result.path.time" value="${result.path}/${now}" />

		<echo message="Writing copy of results to: ${result.path.time}" />
		<copy todir="${result.dir.time}">
			<fileset dir="${result.dir.aktuell}" includes="**/*" />
		</copy>
	</target>
</project>